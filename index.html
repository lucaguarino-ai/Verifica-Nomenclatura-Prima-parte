<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Verifica di Nomenclatura dei composti inorganici - Prima parte</title>
  <style>
    :root{
      --brand:#009900; --brand-d:#007700; --ink:#004d00; --bg:#e6f2e6;
      --card:#f4fbf4; --line:#a6dba6; --chip:#e1f5e1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0}
    .container{max-width:960px;margin:auto;padding:16px}
    h1{margin:8px 0 16px;text-align:center;color:#006600;font-size:clamp(20px,3.8vw,28px)}

    .page-signature{position:fixed;right:10px;bottom:6px;font-weight:700;color:#006600;opacity:.55;pointer-events:none;user-select:none;font-size:11px}

    .inputs-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .inputs-row input{padding:12px;border:1px solid #66cc66;border-radius:10px;font-size:16px;background:#fff;min-width:0}
    .inputs-row .grow{flex:1 1 220px}
    .inputs-row .date{width:160px}

    button{background:var(--brand);color:#fff;padding:12px 18px;border:none;border-radius:999px;cursor:pointer;font-weight:700;letter-spacing:.2px;transition:transform .05s ease,background .15s ease}
    button:active{transform:translateY(1px)}
    button:hover{background:var(--brand-d)}
    .btn-secondary{background:#e1f5e1;color:var(--ink);border:1px solid var(--line)}
    .btn-block{width:100%}

    #result{margin-top:16px;font-size:1.05rem;font-weight:700}

    .list{margin-top:12px;font-size:16px;line-height:1.55}
    .list ul{padding-left:18px;margin:0}
    .list li{margin:12px 0;padding:12px;border-radius:10px;list-style:disc;background:#fff;border:1px solid var(--line)}
    .list li.good{background:#e6f7e6}
    .list li.mid{background:#fff2e0}
    .list li.bad{background:#ffe6e6}

    .exam-header{display:none;align-items:center;justify-content:space-between;gap:16px;padding:10px 12px;border:1px solid #99cc99;border-radius:14px;background:var(--card);margin:10px 0}
    .exam-header .left,.exam-header .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{background:var(--chip);border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-weight:700}

    .quiz-row{display:none;gap:16px;align-items:flex-start}
    .quiz-main{flex:1 1 auto;min-width:0}
    .quiz-side{width:300px;flex:0 0 300px;position:sticky;top:10px;align-self:flex-start}
    @media (max-width:1024px){.quiz-side{display:none}}

    .mini-stack{display:grid;gap:8px}
    .mini-card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px}
    .mini-table{width:100%;border-collapse:collapse;font-size:13px;table-layout:fixed}
    .mini-table th,.mini-table td{border:1px solid var(--line);padding:6px 8px;text-align:left;vertical-align:top;background:#fff;white-space:normal;overflow-wrap:anywhere;word-break:break-word}
    .mini-table th{background:#e6f7e6;color:#005f00}
    .mini-table td:first-child{font-size:12px;width:34%}

    .builder-wrap{margin-top:10px;border:1px dashed #66cc66;border-radius:12px;padding:12px;background:#f6fff6}
    .formula{display:flex;flex-wrap:wrap;gap:6px;align-items:center;min-height:46px;justify-content:center}
    .pair{display:inline-flex;align-items:center;gap:2px}
    .slot,.static{display:inline-flex;align-items:center;min-height:40px;border-radius:8px;font-size:20px}
    .slot{min-width:37px;padding:5px 9px;border:2px solid var(--line);background:#fff;cursor:text;white-space:nowrap}
    .slot.coef{min-width:1.65ch;width:auto;max-width:none;padding:0 2px;justify-content:center;text-align:center}
    .slot.empty{background:#eef9ee}
    .slot.active{outline:3px solid var(--brand);background:#eaffea}
    .slot[contenteditable="true"]{caret-color:#006600}
    .static{padding:0 6px;color:#004d00;font-weight:700}
    .static.arrow{font-size:24px}

    /* Console */
    .kbd-section{margin-top:8px;border-top:1px solid #99cc99;padding-top:8px}
    .kbd-section h4{margin:4px 0;font-size:14px;color:#006600}
    .kbd.one-line{display:flex;flex-wrap:wrap;gap:6px;padding-bottom:2px}
    .kbd{display:grid;grid-template-columns:repeat(auto-fit,minmax(44px,1fr));gap:6px;margin-top:6px}
    .kbd.equal{grid-template-columns:repeat(auto-fit,minmax(54px,1fr))}
    .kbd.equal button{padding:10px;font-size:19px}
    .kbd.equal .sup,.kbd.equal .sub{font-size:19px;line-height:1}
    .kbd button{margin:0;padding:10px 8px;border-radius:10px;background:var(--chip);color:var(--ink);border:1px solid var(--line);font-weight:700;font-size:16px}
    .kbd button:active{transform:translateY(1px)}
    .kbd.tools{display:grid;grid-template-columns:repeat(5,minmax(90px,auto));gap:6px;margin-top:8px}
    .kbd.tools button{padding:10px 6px;font-size:14px}

    .question-block{margin-bottom:16px}
    .q-title{margin-bottom:6px;font-size:19px;line-height:1.25}
    input.answer-field{width:100%;font-size:17px;text-transform:uppercase;padding:12px;border:2px solid var(--line);border-radius:10px}

    .actions{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    @media (min-width:600px){ .actions{grid-template-columns:1fr 1fr} }

    /* Modale PIN */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000}
    .modal.open{display:flex}
    .dialog{background:#fff;border-radius:16px;border:1px solid var(--line);max-width:380px;width:100%;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .dialog h3{margin:0 0 8px}
    .row{display:flex;gap:8px;align-items:center}
    .row input{flex:1 1 auto;padding:12px;border:1px solid var(--line);border-radius:10px;font-size:18px;letter-spacing:4px;text-align:center}
    .row button{white-space:nowrap}
    .help{font-size:13px;color:#2c662d;margin-top:6px}

    .teacher-only{display:none}

    /* Toggle mini-tabelle per domanda (solo mobile) */
    .mini-toggle{margin-top:8px}
    .mini-btn{background:#e1f5e1;color:var(--ink);border:1px solid var(--line);padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer;width:100%}
    .mini-panel{display:none;margin-top:8px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;max-height:45vh;overflow:auto}
    .mini-panel.open{display:block}
    @media(min-width:1025px){.mini-toggle{display:none}}

    /* Console sticky su mobile + scroll orizzontale */
    @media (max-width: 720px){
      .builder-wrap{padding-bottom:96px}
      .kbd-dock{position:sticky;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--line);padding:8px;box-shadow:0 -6px 12px rgba(0,0,0,.08);z-index:50;border-bottom-left-radius:12px;border-bottom-right-radius:12px}
      .kbd-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
      .kbd,.kbd.equal,.kbd.tools{display:inline-flex;gap:6px;margin-top:6px}
      .kbd button,.kbd.tools button{flex:0 0 auto}
      .kbd-section{border-top:none;padding-top:0;margin-top:6px}
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Verifica di Nomenclatura dei composti inorganici - Prima parte</h1>

    <!-- Dati studente -->
    <div id="preData" class="inputs-row" role="group" aria-label="Dati studente">
      <input class="grow" type="text" id="name" placeholder="Nome" autocomplete="off"/>
      <input class="grow" type="text" id="surname" placeholder="Cognome" autocomplete="off"/>
      <input class="grow" type="text" id="class" placeholder="Classe (es. 2A)" autocomplete="off"/>
      <input class="date" type="text" id="date" placeholder="Data" readonly />
      <button id="startBtn">Inizia Verifica</button>
    </div>

    <!-- Header verifica -->
    <div id="examHeader" class="exam-header" aria-live="polite">
      <div class="left">
        <span class="badge" id="hdrStudent"></span>
        <span class="badge" id="hdrDate"></span>
      </div>
      <div class="right">
        <span class="badge" id="hdrStart"></span>
        <span class="badge" id="hdrElapsed"></span>
      </div>
    </div>

    <!-- Layout quiz + sidebar -->
    <div id="quizRow" class="quiz-row">
      <div class="quiz-main">
        <div id="questions" style="display:none;">
          <div id="questionsContainer"></div>
          <div class="actions">
            <button id="submitBtn">Invia Risposte</button>
            <button id="backBtn" class="btn-secondary">Indietro</button>
          </div>
        </div>
      </div>
      <aside id="quizSide" class="quiz-side" style="display:none;" aria-label="Promemoria nomenclatura">
        <div class="mini-stack">
          <div class="mini-card">
            <table class="mini-table" aria-label="Ossidi vs Nome">
              <thead><tr><th>Ossidi</th><th>Nome</th></tr></thead>
              <tbody>
                <tr><td>N.O.</td><td id="ox-row1"></td></tr>
                <tr><td>2 N.O.</td><td id="ox-row2"></td></tr>
                <tr><td>‚â• 3 N.O.</td><td id="ox-row3"></td></tr>
              </tbody>
            </table>
          </div>
          <div class="mini-card">
            <table class="mini-table" aria-label="Anidridi vs Nome">
              <thead><tr><th>Anidridi</th><th>Nome</th></tr></thead>
              <tbody>
                <tr><td>2 N.O.</td><td id="an-row2"></td></tr>
                <tr><td>3 N.O.</td><td id="an-row3"></td></tr>
                <tr><td>4 N.O.</td><td id="an-row4"></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </aside>
    </div>

    <div id="result"></div>
    <div class="list" id="studentList"></div>

    <!-- Area docente -->
    <div class="teacher-only" id="teacherPanel">
      <div style="display:flex;align-items:center;gap:10px;margin:14px 0 6px">
        <h3 style="margin:0">Dettaglio risposte (docente)</h3>
        <button id="exportPdfBtn" class="btn-secondary">Esporta PDF</button>
      </div>
      <div class="list" id="teacherList"></div>
    </div>

    <div id="teacherCta" style="display:none;margin-top:12px">
      <button id="openPinBtn" class="btn-secondary btn-block">Area docenti (PIN)</button>
    </div>
  </div>

  <!-- Modale PIN -->
  <div id="pinModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="pinTitle">
    <div class="dialog">
      <h3 id="pinTitle">Inserisci PIN docente</h3>
      <div class="row">
        <input id="pinInput" type="password" inputmode="numeric" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <button id="pinLoginBtn">Accedi</button>
      </div>
      <div class="help">Il PIN protegge: voto per domanda, risposta corretta, esportazione PDF.</div>
      <div id="pinErr" style="color:#a10000;font-weight:700;margin-top:6px;display:none">PIN errato</div>
    </div>
  </div>

  <div class="page-signature">by LG</div>

  <script>
    const PIN_SALT='nK$-13';
    const PIN_HASH='827703960df0ea495388fe2489d96f090701230416c9312be26d8b3a5e5d06fe'; // hash(salt+5822)
    let pinFailCount=0, pinLockedUntil=0, teacherUnlocked=false;

    const questions = [
      { question: "Scrivi la formula e la reazione di sintesi dell'ossido ferrico:", answer: "2Fe‚Å∫¬≥+3O‚Åª¬≤‚ÜíFe‚ÇÇO‚ÇÉ" },
      { question: "Come si chiama NaOH in nomenclatura tradizionale?", answer: "IDROSSIDO DI SODIO" },
      { question: "Scrivi la formula e la reazione di sintesi dell'anidride perclorica:", answer: "2Cl‚Å∫‚Å∑+7O‚Åª¬≤‚ÜíCl‚ÇÇO‚Çá" },
      { question: "Come si chiama l'HCl in nomenclatura tradizionale?", answer: "ACIDO CLORIDRICO" },
      { question: "Scrivi la formula e la reazione di sintesi del triidruro di azoto:", answer: "N‚Åª¬≥+3H‚Å∫¬π‚ÜíNH‚ÇÉ" },
      { question: "Come si chiama H‚ÇÇSO‚ÇÑ in nomenclatura tradizionale?", answer: "ACIDO SOLFORICO" },
      { question: "Scrivi la formula e la reazione di sintesi dell'idrossido stannico:", answer: "Sn‚Å∫‚Å¥+2O‚Åª¬≤‚ÜíSn‚ÇÇO‚ÇÑ‚ÜíSnO‚ÇÇ+2H‚ÇÇO‚ÜíSn(OH)‚ÇÑ" },
      { question: "Come si chiama V(OH)‚ÇÖ?", answer: "IDROSSIDO DI VANADIO(V)" },
      { question: "Scrivi la formula e la reazione di sintesi dell'acido bromico:", answer: "2Br‚Å∫‚Åµ+5O‚Åª¬≤‚ÜíBr‚ÇÇO‚ÇÖ+H‚ÇÇO‚ÜíH‚ÇÇBr‚ÇÇO‚ÇÜ‚Üí2HBrO‚ÇÉ" },
      { question: "Come si chiama I‚ÇÇO‚ÇÖ in nomenclatura tradizionale?", answer: "ANIDRIDE IODICA" }
    ];

    const synthesisPatterns = {
      0: ['coef','slot','+','coef','slot','‚Üí','slot'],
      2: ['coef','slot','+','coef','slot','‚Üí','slot'],
      4: ['slot','+','coef','slot','‚Üí','slot'],
      6: ['slot','+','coef','slot','‚Üí','slot','‚Üí','slot','+','coef','slot','‚Üí','slot'],
      8: ['coef','slot','+','coef','slot','‚Üí','slot','+','slot','‚Üí','slot','‚Üí','coef','slot']
    };

    const pad2 = n => String(n).padStart(2,'0');
    const formatDateIT = d => `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
    const formatTime = d => `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    const msToHMS = ms => { const s=Math.floor(ms/1000); return `${pad2(Math.floor(s/3600))}:${pad2(Math.floor((s%3600)/60))}:${pad2(s%60)}`; };
    let startTime=null,endTime=null,elapsedTimer=null;

    function ensureCaretInSlot(slot){const sel=window.getSelection();if(!sel||sel.rangeCount===0||!slot.contains(sel.anchorNode))placeCaretAtEnd(slot)}
    function placeCaretAtEnd(el){el.focus();const r=document.createRange();r.selectNodeContents(el);r.collapse(false);const s=window.getSelection();s.removeAllRanges();s.addRange(r)}
    function setCaret(node,offset){const r=document.createRange();r.setStart(node,offset);r.collapse(true);const s=window.getSelection();s.removeAllRanges();s.addRange(r)}
    function previousTextPosition(slot,node){let c=node;while(c&&c!==slot){if(c.previousSibling){c=c.previousSibling;while(c&&c.lastChild)c=c.lastChild; if(c&&c.nodeType===Node.TEXT_NODE){return{node:c,offset:c.nodeValue.length}}}else c=c.parentNode}return null}

    function appendSymbol(sym, wrap){
      const s=getActiveSlot(wrap)||getSlotsInBuilder(wrap)[0]; if(!s) return;
      s.textContent = (s.textContent||'') + sym;
      s.classList.remove('empty');
    }
    function softBackspace(wrap){
      const s=getActiveSlot(wrap); if(!s) return;
      const t=s.textContent||''; s.textContent=t.slice(0,Math.max(0,t.length-1));
      if((s.textContent||'').trim()==='') s.classList.add('empty');
    }

    function createKeyboardSection(title, symbols, opts = {}) {
      const { extraClass = '', includeTools = false, contextWrap, oneLine = false, equal = false } = opts;
      const section = document.createElement('div');
      section.className = 'kbd-section';
      const header = document.createElement('h4');
      header.textContent = title;
      section.appendChild(header);
      const gridWrap = document.createElement('div');
      gridWrap.className = 'kbd-scroll';
      const grid = document.createElement('div');
      grid.className = (oneLine ? 'kbd one-line' : 'kbd') + (equal ? ' equal' : '');
      gridWrap.appendChild(grid);
      symbols.forEach(sym => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = sym;
        if (extraClass) btn.classList.add(extraClass);
        btn.addEventListener('click', () => appendSymbol(sym, contextWrap));
        grid.appendChild(btn);
      });
      section.appendChild(gridWrap);

      if (includeTools) {
        const toolsWrap = document.createElement('div');
        toolsWrap.className = 'kbd-scroll';
        const tools = document.createElement('div');
        tools.className = 'kbd tools';
        [
          { label: '‚óÄÔ∏é', fn: () => moveActive(contextWrap, -1) },
          { label: '‚ñ∂Ô∏é', fn: () => moveActive(contextWrap, +1) },
          { label: '‚å´', fn: () => softBackspace(contextWrap) },
          { label: 'Svuota slot', fn: () => clearActiveSlot(contextWrap) },
          { label: 'Svuota tutto', fn: () => clearAllSlots(contextWrap) }
        ].forEach(s => {
          const b = document.createElement('button');
          b.textContent = s.label;
          b.addEventListener('click', s.fn);
          tools.appendChild(b);
        });
        toolsWrap.appendChild(tools);
        section.appendChild(toolsWrap);
      }
      return section;
    }

    const getSlotsInBuilder = b => Array.from(b.querySelectorAll('.slot'));
    const getActiveSlot = b => b.querySelector('.slot.active')||getSlotsInBuilder(b)[0]||null;
    function setActiveSlot(s,preserveCaret){const b=s.closest('.builder-wrap');getSlotsInBuilder(b).forEach(x=>x.classList.remove('active'));s.classList.add('active');if(!preserveCaret)placeCaretAtEnd(s)}
    function insertAtCaret(text,b){const s=getActiveSlot(b);if(!s)return;ensureCaretInSlot(s);const sel=window.getSelection();let r=sel.getRangeAt(0);
      if(r.startContainer.nodeType!==Node.TEXT_NODE){const tn=document.createTextNode('');r.insertNode(tn);setCaret(tn,tn.length);r=sel.getRangeAt(0)}
      if(!r.collapsed)r.deleteContents();const node=r.startContainer,pos=r.startOffset;const chars=Array.from(node.nodeValue||''),add=Array.from(text);
      chars.splice(pos,0,...add);node.nodeValue=chars.join('');setCaret(node,pos+add.length); if(s.textContent.trim().length>0)s.classList.remove('empty')}
    function backspaceAtCaret(b){const s=getActiveSlot(b);if(!s)return;ensureCaretInSlot(s);const sel=window.getSelection();let r=sel.getRangeAt(0);
      if(!r.collapsed){r.deleteContents();return;} if(r.startContainer.nodeType!==Node.TEXT_NODE){const prev=previousTextPosition(s,r.startContainer);
        if(prev){const t=Array.from(prev.node.nodeValue);if(t.length>0){t.pop();prev.node.nodeValue=t.join('');setCaret(prev.node,t.length)}}}
      else {const node=r.startContainer,pos=r.startOffset;if(pos>0){const t=Array.from(node.nodeValue);t.splice(pos-1,1);node.nodeValue=t.join('');setCaret(node,pos-1)}
        else {const prev=previousTextPosition(s,node);if(prev){const t=Array.from(prev.node.nodeValue);if(t.length>0){t.pop();prev.node.nodeValue=t.join('');setCaret(prev.node,t.length)}}}}
      if(s.textContent.trim().length===0)s.classList.add('empty')}
    function moveActive(b,dir){const slots=getSlotsInBuilder(b);if(!slots.length)return;const c=getActiveSlot(b)||slots[0];const i=slots.indexOf(c);const n=slots[Math.min(Math.max(i+dir,0),slots.length-1)];if(n)setActiveSlot(n,true)}
    function clearActiveSlot(b){const s=getActiveSlot(b);if(!s)return;s.textContent='';s.classList.add('empty')}
    function clearAllSlots(b){getSlotsInBuilder(b).forEach(s=>{s.textContent='';s.classList.add('empty')})}
    function readBuilderValue(b){const parts=[];b.querySelectorAll('.formula > span').forEach(el=>{if(el.classList.contains('pair')){el.querySelectorAll('.slot').forEach(s=>parts.push(s.textContent))}else{parts.push(el.textContent)}});return parts.join('')}

    function createSlot({coef=false}) {
      const slot = document.createElement('span');
      slot.className = 'slot empty' + (coef ? ' coef' : '');
      slot.contentEditable = 'true';
      slot.spellcheck = false;
      slot.addEventListener('focus', () => setActiveSlot(slot, true));
      slot.addEventListener('click', () => setActiveSlot(slot, true));
      slot.addEventListener('input', () => {
        if (slot.textContent.trim().length > 0) slot.classList.remove('empty');
        else slot.classList.add('empty');
      });
      return slot;
    }

    function createBuilderFromPattern(pattern, qIndex) {
      const wrap = document.createElement('div');
      wrap.className = 'builder-wrap';
      wrap.dataset.qindex = qIndex;
      const formula = document.createElement('div');
      formula.className = 'formula';
      wrap.appendChild(formula);

      for (let i = 0; i < pattern.length; i++) {
        const tok = pattern[i];
        if (tok === 'coef' && pattern[i+1] === 'slot') {
          const pair = document.createElement('span');
          pair.className = 'pair';
          pair.appendChild(createSlot({ coef:true }));
          pair.appendChild(createSlot({ coef:false }));
          formula.appendChild(pair);
          i++;
          continue;
        }
        if (tok === 'slot') formula.appendChild(createSlot({ coef:false }));
        else if (tok === 'coef') formula.appendChild(createSlot({ coef:true }));
        else {
          const s = document.createElement('span');
          s.className = 'static' + (tok === '‚Üí' ? ' arrow' : '');
          s.textContent = tok;
          formula.appendChild(s);
        }
      }

      const dock = document.createElement('div');
      dock.className = 'kbd-dock';
      dock.appendChild(createKeyboardSection(
        "Elementi e numeri",
        ['H','O','N','S','Fe','Sn','Br','I','Cl','OH','H‚ÇÇO','1','2','3','4','5','6','7','8','(',')'],
        { includeTools: true, contextWrap: wrap, oneLine: true }
      ));
      dock.appendChild(createKeyboardSection(
        "Numeri di ossidazione",
        ['‚Å∫¬π','‚Å∫¬≤','‚Å∫¬≥','‚Å∫‚Å¥','‚Å∫‚Åµ','‚Å∫‚Å∂','‚Å∫‚Å∑','‚Åª¬π','‚Åª¬≤','‚Åª¬≥','‚Åª‚Å¥'],
        { extraClass: 'sup', includeTools: false, contextWrap: wrap, equal: true }
      ));
      dock.appendChild(createKeyboardSection(
        "Indici",
        ['‚ÇÅ','‚ÇÇ','‚ÇÉ','‚ÇÑ','‚ÇÖ','‚ÇÜ','‚Çá','‚Çà'],
        { extraClass: 'sub', includeTools: false, contextWrap: wrap, equal: true }
      ));
      wrap.appendChild(dock);

      const mt = document.createElement('div');
      mt.className = 'mini-toggle';
      mt.innerHTML = '<button type="button" class="mini-btn" aria-expanded="false">Mostra mini-tabelle üìò</button>';
      const panel = document.createElement('div');
      panel.className = 'mini-panel';
      panel.setAttribute('hidden','');
      panel.innerHTML = `
        <table class="mini-table" aria-label="Ossidi vs Nome" style="margin-bottom:8px">
          <thead><tr><th>Ossidi</th><th>Nome</th></tr></thead>
          <tbody>
            <tr><td>N.O.</td><td>nome del Me</td></tr>
            <tr><td>2 N.O.</td><td>n.o. + basso ‚Üí suffisso oso; n.o. + alto ‚Üí suffisso ico</td></tr>
            <tr><td>‚â• 3 N.O.</td><td>n.o. + basso ‚Üí suffisso oso; n.o. successivo a quello + basso ‚Üí suffisso ico; n.o. superiori ‚Üí notazione di Stock</td></tr>
          </tbody>
        </table>
        <table class="mini-table" aria-label="Anidridi vs Nome">
          <thead><tr><th>Anidridi</th><th>Nome</th></tr></thead>
          <tbody>
            <tr><td>2 N.O.</td><td>n.o. + basso ‚Üí suffisso osa; n.o. + alto ‚Üí suffisso ica</td></tr>
            <tr><td>3 N.O.</td><td>+1 ‚Üí ipo....osa; +3 o +4 ‚Üí suffisso osa; +5 o +6 ‚Üí suffisso ica</td></tr>
            <tr><td>4 N.O.</td><td>+1 ‚Üí ipo....osa; +3 o +4 ‚Üí suffisso osa; +5 o +6 ‚Üí suffisso ica; +7 ‚Üí per....ica</td></tr>
          </tbody>
        </table>`;
      mt.querySelector('button').addEventListener('click',(ev)=>{
        const btn = ev.currentTarget;
        const open = panel.classList.toggle('open');
        if(open){ panel.removeAttribute('hidden'); btn.setAttribute('aria-expanded','true'); btn.textContent='Nascondi mini-tabelle üìò'; }
        else { panel.setAttribute('hidden',''); btn.setAttribute('aria-expanded','false'); btn.textContent='Mostra mini-tabelle üìò'; }
      });
      wrap.appendChild(mt);
      wrap.appendChild(panel);

      return wrap;
    }

    function levenshtein(a,b){const m=[];for(let i=0;i<=b.length;i++)m[i]=[i];for(let j=0;j<=a.length;j++)m[0][j]=j;for(let i=1;i<=b.length;i++){for(let j=1;j<=a.length;j++){m[i][j]=b.charAt(i-1)===a.charAt(j-1)?m[i-1][j-1]:Math.min(m[i-1][j-1]+1,m[i][j-1]+1,m[i-1][j]+1)}}return m[b.length][a.length]}
    const RX_STRIP_EMPTY = /[\s+\u2192]/g;
    const normForEmpty = str => (str || '').replace(RX_STRIP_EMPTY, '').trim();
    const normForSim = (str, isSynth=false) => { let s=(str||'').replace(/\s+/g,''); if(!isSynth) s=s.toUpperCase(); return s; };
    const isEmptyAnswer = ans => normForEmpty(ans) === '';
    const getQuestionMax = i => synthesisPatterns[i] ? 2 : 1;

    function renderTeacherDetails(results){
      const tDiv = document.getElementById('teacherList');
      let html = '<ul>';
      results.forEach(e=>{
        const dispPoint = (Math.round(e.point*100)/100).toFixed(2);
        html+=`<li class="${e.color}">
          <strong>Domanda:</strong> ${e.question}<br>
          <strong>Tua risposta:</strong> ${e.yourAnswer || '<em>(vuota)</em>'}<br>
          <strong>Risposta corretta:</strong> ${e.correctAnswer}<br>
          <strong>Punteggio domanda:</strong> ${dispPoint} / ${e.max}
        </li>`;
      });
      html += '</ul>';
      tDiv.innerHTML = html;
    }

    function exportPdf(){
      if(!teacherUnlocked){ alert('Area docenti bloccata. Inserire il PIN.'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      function addSignature(){ doc.setFontSize(8); const text = 'by LG'; const w = doc.getTextWidth(text); doc.text(text, pageW - w - 5, pageH - 5) }
      function textWidthAt(str, size){ const old = doc.getFontSize(); if(size) doc.setFontSize(size); const w = doc.getTextWidth(str); if(size) doc.setFontSize(old); return w }
      function drawArrowInline(x,y,size=10){ const shaft=size*0.75, head=size*0.30; doc.setLineWidth(0.5); doc.line(x, y-1, x+shaft, y-1); const hx=x+shaft, hy=y-1; doc.line(hx,hy,hx+head,hy); doc.line(hx+head,hy,hx+head-2.4,hy-1.9); doc.line(hx+head,hy,hx+head-2.4,hy+1.9); return head + shaft }
      function drawGreaterEqualInline(x,y,size=10){ const w=size*0.52; doc.setLineWidth(0.5); doc.line(x, y-1.2, x+w, y-1.2); doc.line(x+w, y-1.2, x+w-3, y-1.2-2); doc.line(x+w, y-1.2, x+w-3, y-1.2+2); doc.line(x, y+1.2, x+w, y+1.2); return w + 1.2 }
      const SUP_MAP = { '‚Å∞':'0','¬π':'1','¬≤':'2','¬≥':'3','‚Å¥':'4','‚Åµ':'5','‚Å∂':'6','‚Å∑':'7','‚Å∏':'8','‚Åπ':'9','‚Å∫':'+','‚Åª':'-' };
      const SUB_MAP = { '‚ÇÄ':'0','‚ÇÅ':'1','‚ÇÇ':'2','‚ÇÉ':'3','‚ÇÑ':'4','‚ÇÖ':'5','‚ÇÜ':'6','‚Çá':'7','‚Çà':'8','‚Åπ':'9' };
      function chemToTokens(text){
        const tokens=[]; let i=0; text=String(text||'');
        while(i<text.length){
          const ch=text[i];
          if(ch==='‚Üí'){ tokens.push({type:'arrow'}); i++; continue }
          if(ch==='‚â•'){ tokens.push({type:'ge'}); i++; continue }
          if (SUP_MAP[ch]){ let s=''; while(i<text.length && SUP_MAP[text[i]]) s+=SUP_MAP[text[i++]]; tokens.push({type:'sup',val:s}); continue }
          if (SUB_MAP[ch]){ let s=''; while(i<text.length && SUB_MAP[text[i]]) s+=SUB_MAP[text[i++]]; tokens.push({type:'sub',val:s}); continue }
          let run='';
          while(i<text.length && !SUP_MAP[text[i]] && !SUB_MAP[text[i]] && text[i]!=='‚Üí' && text[i]!=='‚â•'){ run+=text[i++]; }
          if (run){ const parts = run.split(/(\s+)/); parts.forEach(p=>{ if(p) tokens.push({type:'base', val:p}) }); }
        }
        return tokens;
      }
      function measureTokenWidth(tok, baseSize=10){
        if(tok.type==='arrow') return drawArrowInline(0,0,baseSize);
        if(tok.type==='ge')    return drawGreaterEqualInline(0,0,baseSize);
        if(tok.type==='base')  return textWidthAt(tok.val, baseSize);
        const small = baseSize*0.75;
        if(tok.type==='sup' || tok.type==='sub') return textWidthAt(tok.val, small);
        return 0;
      }
      function wrapTokensToLines(tokens, maxWidth, baseSize=10){
        const lines=[]; let line=[], w=0;
        tokens.forEach(tok=>{
          const twTok = measureTokenWidth(tok, baseSize);
          if (w + twTok <= maxWidth || line.length===0){ line.push(tok); w += twTok; }
          else { lines.push(line); line=[tok]; w = twTok; }
        });
        if (line.length) lines.push(line);
        return lines;
      }
      function renderChemWrapped(text, x, y, maxWidth, baseSize=10, lineGap=9){
        const tokens = chemToTokens(String(text));
        const lines = wrapTokensToLines(tokens, maxWidth, baseSize);
        let cy = y;
        const oldSize = doc.getFontSize();
        lines.forEach(line=>{
          let cx = x;
          line.forEach(tok=>{
            if(tok.type==='arrow'){ cx += drawArrowInline(cx, cy, baseSize); }
            else if(tok.type==='ge'){ cx += drawGreaterEqualInline(cx, cy, baseSize); }
            else if(tok.type==='base'){ doc.setFontSize(baseSize); doc.text(tok.val, cx, cy); cx += textWidthAt(tok.val, baseSize); }
            else if(tok.type==='sup'){ const s=baseSize*0.75; doc.setFontSize(s); doc.text(tok.val, cx, cy - baseSize*0.35); cx += textWidthAt(tok.val, s); }
            else if(tok.type==='sub'){ const s=baseSize*0.75; doc.setFontSize(s); doc.text(tok.val, cx, cy + baseSize*0.25); cx += textWidthAt(tok.val, s); }
          });
          cy += lineGap;
          if (cy > pageH - 20){ doc.addPage(); addSignature(); cy = 12; }
        });
        doc.setFontSize(oldSize);
        return cy;
      }

      doc.setFontSize(14); doc.text('Verifica di Nomenclatura dei composti inorganici - Prima parte', 10, 10);
      doc.setFontSize(12);
      const dateStr=document.getElementById('date').value;
      const nameFull=document.getElementById('hdrStudent').textContent || '';
      const startStr=document.getElementById('hdrStart').textContent.replace('Inizio: ','') || '';
      const endStr=(function(){const d=new Date();return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`})();
      const elapsedStr=(function(){const r=document.getElementById('result').textContent.match(/Trascorso:\s*([0-9:]+)/);return r? r[1] : ''})()
      doc.text(`Studente: ${nameFull}`, 10, 20);
      doc.text(`Data: ${dateStr}`, 10, 28);
      doc.text(`Inizio: ${startStr}`, 10, 36);
      doc.text(`Fine: ${endStr}`, 10, 44);
      doc.text(`Trascorso: ${elapsedStr}`, 10, 52);

      const finalMatch = document.getElementById('result').textContent.match(/Punteggio:\s*([0-9.]+)\/10/);
      const finalScore = finalMatch ? finalMatch[1] : '';
      doc.text(`Punteggio finale: ${finalScore}/10`, 10, 60);

      let y=74; const baseSize=10, lineGap=9, blockGap=12; const rightMarginX = pageW - 10;
      const lis = Array.from(document.querySelectorAll('#teacherList li'));
      lis.forEach(li=>{
        const html=li.innerHTML;
        const getField=label=>{const rx=new RegExp(`<strong>${label}:<\/strong>\\s*([^<]+)`,'i'); const m=html.match(rx); return m?m[1]:''};
        const e={question:getField('Domanda'), yourAnswer:getField('Tua risposta')||'(vuota)', correctAnswer:getField('Risposta corretta'), point:getField('Punteggio domanda')};
        doc.setFontSize(baseSize); doc.text('Domanda:', 10, y); y = renderChemWrapped(e.question, 38, y, rightMarginX - 38, baseSize, lineGap);
        doc.text('Tua risposta:', 10, y); y = renderChemWrapped(e.yourAnswer, 38, y, rightMarginX - 38, baseSize, lineGap);
        doc.text('Risposta corretta:', 10, y); y = renderChemWrapped(e.correctAnswer, 58, y, rightMarginX - 58, baseSize, lineGap);
        doc.text(e.point ? `Punteggio: ${e.point}` : `Punteggio: ‚Äî`, 10, y); y += blockGap; if (y > pageH - 20) { doc.addPage(); addSignature(); y = 12; }
      });

      addSignature();
      doc.save(`Verifica_${(nameFull.split(' (')[0] || 'Studente').replaceAll(' ','_')}.pdf`);
    }

    async function sha256Hex(str){
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    async function checkPin(input){
      if(!input) return false;
      try{ const hex = await sha256Hex(PIN_SALT + input); return hex === PIN_HASH; }catch{ return false }
    }
    function openPinModal(){
      document.getElementById('pinModal').classList.add('open');
      const input = document.getElementById('pinInput');
      input.value='';
      input.focus();
      document.getElementById('pinErr').style.display='none';
    }
    function closePinModal(){ document.getElementById('pinModal').classList.remove('open') }
    async function verifyPin(){
      const now = Date.now();
      if(now < pinLockedUntil){
        const sec = Math.ceil((pinLockedUntil-now)/1000);
        const err = document.getElementById('pinErr');
        err.textContent = `Attendi ${sec}s prima di riprovare.`;
        err.style.display='block';
        return;
      }
      const val = (document.getElementById('pinInput').value||'').trim();
      const ok = await checkPin(val);
      if(ok){
        teacherUnlocked = true;
        pinFailCount = 0; pinLockedUntil = 0;
        closePinModal();
        document.getElementById('teacherPanel').style.display='block';
        document.getElementById('teacherCta').style.display='none';
      } else {
        pinFailCount++;
        if(pinFailCount>=5){ pinLockedUntil = Date.now() + 60_000; pinFailCount=0; }
        const err = document.getElementById('pinErr');
        err.textContent = 'PIN errato';
        err.style.display='block';
      }
    }

    function startQuiz(){
      const n=document.getElementById('name').value.trim(),
            s=document.getElementById('surname').value.trim(),
            c=document.getElementById('class').value.trim(),
            dateStr=document.getElementById('date').value.trim();
      if(!n||!s||!c){alert("Compila tutti i campi (nome, cognome, classe) per iniziare.");return;}

      document.getElementById('preData').style.display='none';
      document.getElementById('examHeader').style.display='flex';
      document.getElementById('hdrStudent').textContent=`${n} ${s} (${c})`;
      document.getElementById('hdrDate').textContent=`Data: ${dateStr}`;
      startTime=new Date();
      document.getElementById('hdrStart').textContent=`Inizio: ${formatTime(startTime)}`;
      document.getElementById('hdrElapsed').textContent=`Trascorso: 00:00:00`;
      if(elapsedTimer)clearInterval(elapsedTimer);
      elapsedTimer=setInterval(()=>{const now=new Date();const diff=now-startTime;document.getElementById('hdrElapsed').textContent=`Trascorso: ${msToHMS(diff)}`;},1000);

      document.getElementById('quizRow').style.display = 'flex';
      document.getElementById('quizSide').style.display = (window.matchMedia('(min-width:1025px)').matches ? 'block' : 'none');

      document.getElementById('ox-row1').textContent = "nome del Me";
      document.getElementById('ox-row2').textContent = "n.o. + basso ‚Üí suffisso oso; n.o. + alto ‚Üí suffisso ico";
      document.getElementById('ox-row3').textContent = "n.o. + basso ‚Üí suffisso oso; n.o. successivo a quello + basso ‚Üí suffisso ico; n.o. superiori ‚Üí notazione di Stock";
      document.getElementById('an-row2').textContent = "n.o. + basso ‚Üí suffisso osa; n.o. + alto ‚Üí suffisso ica";
      document.getElementById('an-row3').textContent = "+1 ‚Üí ipo....osa; +3 o +4 ‚Üí suffisso osa; +5 o +6 ‚Üí suffisso ica";
      document.getElementById('an-row4').textContent = "+1 ‚Üí ipo....osa; +3 o +4 ‚Üí suffisso osa; +5 o +6 ‚Üí suffisso ica; +7 ‚Üí per....ica";

      document.getElementById('questions').style.display='block';
      const container=document.getElementById('questionsContainer'); container.innerHTML='';
      questions.forEach((q,i)=>{
        const block=document.createElement('div'); block.className='question-block';
        const label=document.createElement('div'); label.className='q-title'; label.innerHTML=(i+1)+". "+q.question; block.appendChild(label);
        if(synthesisPatterns[i]){const builder=createBuilderFromPattern(synthesisPatterns[i],i); builder.id='builder_'+i; block.appendChild(builder);}
        else {const input=document.createElement('input'); input.type='text'; input.id='q'+i; input.placeholder='Risposta'; input.className='answer-field'; input.maxLength=30; input.addEventListener('input',()=>{input.value=input.value.toUpperCase()}); block.appendChild(input);}
        container.appendChild(block);
      });

      const firstInput = container.querySelector('input.answer-field, .slot');
      if(firstInput){ firstInput.focus() }
    }

    function submitQuiz(){
      const nameFull=document.getElementById('hdrStudent').textContent;
      const rawNameMatch=/^(.*?) \(/.exec(nameFull);
      const studentName=rawNameMatch?rawNameMatch[1]:nameFull;
      const classMatch=/\((.*?)\)/.exec(nameFull);
      const studentClass=classMatch?classMatch[1]:'';

      endTime=new Date();
      if(elapsedTimer){clearInterval(elapsedTimer); elapsedTimer=null}

      let totalScore=0, totalPossible=0;
      const results=[];

      questions.forEach((q,i)=>{
        const isSynth=!!synthesisPatterns[i];
        const maxVal=getQuestionMax(i);
        totalPossible+=maxVal;

        let userAnswer='';
        if(isSynth){ const builder=document.getElementById('builder_'+i); userAnswer=readBuilderValue(builder); }
        else { userAnswer=(document.getElementById('q'+i)?.value||'').trim().toUpperCase(); }

        let point=0;
        if(!isEmptyAnswer(userAnswer)){
          const u = normForSim(userAnswer, isSynth);
          const c = normForSim(isSynth ? q.answer : q.answer.toUpperCase(), isSynth);
          if(u.length>0 && c.length>0){
            const sim = 1 - (levenshtein(u, c) / Math.max(u.length, c.length));
            if(sim >= 1){ point = maxVal; }
            else if(sim < 0.2){ point = 0; }
            else { const pen = Math.max(0, sim - 0.05); point = maxVal * Math.pow(pen, 2); point = Math.max(0, Math.min(point, maxVal)); }
          }
        }
        totalScore+=point;

        let colorClass='bad';
        if(point>=maxVal){ colorClass='good'; }
        else if(point>=maxVal/2){ colorClass='mid'; }

        results.push({ question:q.question, yourAnswer:userAnswer, correctAnswer:q.answer, point:point, max:maxVal, color:colorClass });
      });

      const finalScore = Math.round((totalScore / totalPossible) * 10 * 100) / 100;

      const dateStr=document.getElementById('hdrDate').textContent.replace('Data: ','');
      const startStr=document.getElementById('hdrStart').textContent.replace('Inizio: ','');
      const endStr=formatTime(endTime);
      const elapsedStr=msToHMS(endTime - startTime);

      let res=`${studentName} (${studentClass}) ‚Äî Data: ${dateStr} ‚Äî Inizio: ${startStr} ‚Äî Fine: ${endStr} ‚Äî Trascorso: ${elapsedStr}<br>`;
      res += `Punteggio: ${finalScore}/10`;
      res += finalScore>=6 ? " ‚Äî Bravo! üòâüí™" : " ‚Äî Peccato, studia meglio per la prossima verifica. üòâ";
      if(finalScore<6) document.body.style.backgroundColor='#ffefef';
      document.getElementById('result').innerHTML=res;

      document.getElementById('examHeader').style.display = 'none';
      document.getElementById('quizSide').style.display = 'none';
      document.getElementById('questions').style.display='none';

      const studentDiv = document.getElementById('studentList');
      let sHtml = '<h3>Le tue risposte</h3><ul>';
      results.forEach(e=>{
        sHtml+=`<li><strong>Domanda:</strong> ${e.question}<br><strong>Tua risposta:</strong> ${e.yourAnswer || '<em>(vuota)</em>'}</li>`;
      });
      sHtml+="</ul>";
      studentDiv.innerHTML = sHtml;

      document.getElementById('teacherCta').style.display='block';
      renderTeacherDetails(results);

      document.getElementById('exportPdfBtn').addEventListener('click', exportPdf, { once:true });
      document.getElementById('result').scrollIntoView({behavior:'smooth'});
    }

    function goBack(){
      if(!confirm('Vuoi davvero tornare indietro? Le risposte inserite andranno perse.')) return;
      if(elapsedTimer){ clearInterval(elapsedTimer); elapsedTimer=null }
      teacherUnlocked=false; pinFailCount=0; pinLockedUntil=0;
      document.getElementById('questionsContainer')?.replaceChildren();
      document.getElementById('questions').style.display='none';
      document.getElementById('result').innerHTML='';
      document.getElementById('studentList').innerHTML='';
      document.getElementById('teacherList').innerHTML='';
      document.getElementById('teacherPanel').style.display='none';
      document.getElementById('teacherCta').style.display='none';
      document.body.style.backgroundColor='var(--bg)';
      document.getElementById('preData').style.display='flex';
      document.getElementById('examHeader').style.display='none';
      document.getElementById('quizRow').style.display='none';
      document.getElementById('quizSide').style.display='none';
      window.scrollTo({top:0,behavior:'smooth'});
    }

    document.addEventListener('DOMContentLoaded', () => {
      const dateEl = document.getElementById('date');
      if (dateEl) dateEl.value = formatDateIT(new Date());

      document.getElementById('startBtn').addEventListener('click', startQuiz);
      document.getElementById('submitBtn').addEventListener('click', submitQuiz);
      document.getElementById('backBtn').addEventListener('click', goBack);

      document.getElementById('openPinBtn').addEventListener('click', openPinModal);
      document.getElementById('pinLoginBtn').addEventListener('click', verifyPin);
      document.getElementById('pinInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); verifyPin(); } });
    });
  </script>
</body>
</html>
