<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Verifica di Nomenclatura dei composti inorganici - Prima parte</title>
  <style>
    :root{
      --brand:#009900; --brand-d:#007700; --ink:#004d00; --bg:#e6f2e6;
      --card:#f4fbf4; --line:#a6dba6; --chip:#e1f5e1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0}
    .container{max-width:960px;margin:auto;padding:16px}
    h1{margin:8px 0 16px;text-align:center;color:#006600;font-size:clamp(20px,3.8vw,28px)}

    .page-signature{position:fixed;right:10px;bottom:6px;font-weight:700;color:#006600;opacity:.55;pointer-events:none;user-select:none;font-size:11px}

    .inputs-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .inputs-row input{padding:12px;border:1px solid #66cc66;border-radius:10px;font-size:16px;background:#fff;min-width:0}
    .inputs-row .grow{flex:1 1 220px}
    .inputs-row .date{width:160px}

    button{background:var(--brand);color:#fff;padding:12px 18px;border:none;border-radius:999px;cursor:pointer;font-weight:700;letter-spacing:.2px;transition:transform .05s ease,background .15s ease}
    button:active{transform:translateY(1px)}
    button:hover{background:var(--brand-d)}
    .btn-secondary{background:#e1f5e1;color:var(--ink);border:1px solid var(--line)}
    .btn-block{width:100%}

    #result{margin-top:16px;font-size:1.05rem;font-weight:700}

    .list{margin-top:12px;font-size:16px;line-height:1.55}
    .list ul{padding-left:18px;margin:0}
    .list li{margin:12px 0;padding:12px;border-radius:10px;list-style:disc;background:#fff;border:1px solid var(--line)}
    .list li.good{background:#e6f7e6}
    .list li.mid{background:#fff2e0}
    .list li.bad{background:#ffe6e6}

    .exam-header{display:none;align-items:center;justify-content:space-between;gap:16px;padding:10px 12px;border:1px solid #99cc99;border-radius:14px;background:var(--card);margin:10px 0}
    .exam-header .left,.exam-header .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{background:var(--chip);border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-weight:700}

    .quiz-row{display:none;gap:16px;align-items:flex-start}
    .quiz-main{flex:1 1 auto;min-width:0}
    .quiz-side{width:300px;flex:0 0 300px;position:sticky;top:10px;align-self:flex-start}
    @media (max-width:1024px){.quiz-side{display:none}}

    .mini-stack{display:grid;gap:8px}
    .mini-card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px}
    .mini-table{width:100%;border-collapse:collapse;font-size:13px;table-layout:fixed}
    .mini-table th,.mini-table td{border:1px solid var(--line);padding:6px 8px;text-align:left;vertical-align:top;background:#fff;white-space:normal;overflow-wrap:anywhere;word-break:break-word}
    .mini-table th{background:#e6f7e6;color:#005f00}
    .mini-table td:first-child{font-size:12px;width:34%}

    .question-block{margin-bottom:16px}
    .q-title{margin-bottom:6px;font-size:19px;line-height:1.25}
    input.answer-field{
      width: min(100%, 520px);
      font-size: 17px;
      padding: 10px 12px;
      border: 2px solid var(--line);
      border-radius: 10px;
      box-sizing: border-box;
    }
    @media (max-width:600px){
      input.answer-field{width:100%}
    }

    .builder-wrap{margin-top:10px;border:1px dashed #66cc66;border-radius:12px;padding:12px;background:#f6fff6}
    .formula{
      display:flex;flex-wrap:wrap;
      gap:4px;
      align-items:center;min-height:42px;justify-content:center
    }
    .pair{display:inline-flex;align-items:center;gap:2px}
    .slot,.static{
      display:inline-flex;align-items:center;
      min-height:38px;
      border-radius:8px;
      font-size:20px;
    }
    .slot{
      min-width:36px;
      padding:5px 8px;
      border:2px solid var(--line);
      background:#fff;cursor:text;white-space:nowrap
    }
    .slot.coef{
      min-width:1.45ch;
      width:auto;max-width:none;
      padding:0 2px;
      justify-content:center;text-align:center
    }
    .slot.empty{background:#eef9ee}
    .slot.active{outline:3px solid var(--brand);background:#eaffea}
    .slot[contenteditable="true"]{caret-color:#006600}
    .static{padding:0 5px;color:#004d00;font-weight:700}
    .static.arrow{font-size:22px}

    .kbd-dock{margin-top:8px}
    .kbd-section{margin-top:8px;border-top:1px solid #99cc99;padding-top:8px}
    .kbd-title{margin:0 0 6px;font-size:14px;color:#006600;font-weight:700}
    .kbd-rows{display:flex;flex-direction:column;gap:6px}
    .kbd-row{display:flex;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch}
    .kbd-btn{margin:0;padding:8px 8px;border-radius:10px;background:var(--chip);color:var(--ink);border:1px solid var(--line);font-weight:700;font-size:14px;flex:0 0 auto}
    .kbd-btn:active{transform:translateY(1px)}
    .kbd-btn.tool{font-size:13px;padding:8px 10px}
    .kbd-btn.no{font-size:20px;padding:12px 13px}
    .kbd-btn.sub{font-size:20px;padding:12px 13px}

    @media (max-width: 720px){
      .builder-wrap{padding-bottom:110px}
      .kbd-dock{position:sticky;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--line);padding:8px;box-shadow:0 -6px 12px rgba(0,0,0,.08);z-index:50;border-bottom-left-radius:12px;border-bottom-right-radius:12px}
    }

    @media (min-width:1025px){
      .mini-toggle, .mini-panel { display: none !important; }
    }

    .modal{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.35);
      z-index: 9999;
      padding: 16px;
    }
    .modal.open{ display: flex; }
    .modal .dialog{
      background: #ffffff;
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 20px 40px rgba(0,0,0,.18);
      width: 100%;
      max-width: 300px;
      padding: 10px 12px;
    }
    .modal .row{ display:flex; gap:6px; margin-top:8px; }
    .modal input#pinInput{
      flex: 1 1 auto; padding: 8px 10px; border: 2px solid var(--line); border-radius: 8px; font-size: 16px; width: 100%;
    }
    .modal button#pinLoginBtn{ white-space:nowrap; padding:8px 10px; border-radius:8px; font-size:15px; }
    .modal .help{ margin-top:6px; font-size:13px; color:#335533; }
    @media (max-width:480px){
      .modal .dialog{ max-width:260px; padding:8px 10px; }
      .modal input#pinInput{ font-size:15px; padding:7px 8px; }
    }

    #restoreModal .dialog{ max-width: 360px; }
    #restoreModal .actions{ display:flex; gap:8px; margin-top:12px; }
    #restoreModal .actions button{ flex:1 1 auto; border-radius:10px }
    #restoreModal p{ margin:10px 0 0; line-height:1.4 }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Verifica di Nomenclatura dei composti inorganici - Prima parte</h1>

    <!-- Dati studente -->
    <div id="preData" class="inputs-row" role="group" aria-label="Dati studente">
      <input class="grow" type="text" id="name" placeholder="Nome" autocomplete="off"/>
      <input class="grow" type="text" id="surname" placeholder="Cognome" autocomplete="off"/>
      <input class="grow" type="text" id="class" placeholder="Classe (es. 2A)" autocomplete="off"/>
      <input class="date" type="text" id="date" placeholder="Data" readonly />
      <button id="startBtn">Inizia Verifica</button>
    </div>

    <!-- Header verifica -->
    <div id="examHeader" class="exam-header" aria-live="polite">
      <div class="left">
        <span class="badge" id="hdrStudent"></span>
        <span class="badge" id="hdrDate"></span>
      </div>
      <div class="right">
        <span class="badge" id="hdrStart"></span>
        <span class="badge" id="hdrElapsed"></span>
      </div>
    </div>

    <!-- Layout quiz + sidebar -->
    <div id="quizRow" class="quiz-row">
      <div class="quiz-main">
        <div id="questions" style="display:none;">
          <div id="questionsContainer"></div>
          <div class="actions">
            <button id="submitBtn">Invia Risposte</button>
            <button id="backBtn" class="btn-secondary">Indietro</button>
          </div>
        </div>
      </div>
      <aside id="quizSide" class="quiz-side" style="display:none;" aria-label="Promemoria nomenclatura">
        <div class="mini-stack">
          <div class="mini-card">
            <table class="mini-table" aria-label="Ossidi/Idrossidi vs Nome">
              <thead><tr><th>Ossidi/Idrossidi</th><th>Nome</th></tr></thead>
              <tbody>
                <tr><td>N.O.</td><td id="ox-row1"></td></tr>
                <tr><td>2 N.O.</td><td id="ox-row2"></td></tr>
                <tr><td>‚â• 3 N.O.</td><td id="ox-row3"></td></tr>
              </tbody>
            </table>
          </div>
          <div class="mini-card">
            <table class="mini-table" aria-label="Anidridi/Ossiacidi vs Nome">
              <thead><tr><th>Anidridi/Ossiacidi</th><th>Nome</th></tr></thead>
              <tbody>
                <tr><td>2 N.O.</td><td id="an-row2"></td></tr>
                <tr><td>3 N.O.</td><td id="an-row3"></td></tr>
                <tr><td>4 N.O.</td><td id="an-row4"></td></tr>
              </tbody>
            </table>
          </div>
          <!-- Idruri / Idracidi -->
          <div class="mini-card">
            <table class="mini-table" aria-label="Idruri e Idracidi">
              <thead><tr><th>Categoria</th><th>Nome</th></tr></thead>
              <tbody>
                <tr><td>Idruri</td><td>Nomenclatura IUPAC</td></tr>
                <tr><td>Idracidi</td><td>___idrico</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </aside>
    </div>

    <div id="result"></div>
    <div class="list" id="studentList"></div>

    <!-- Area docente -->
    <div class="teacher-only" id="teacherPanel" style="display:none;">
      <div style="display:flex;align-items:center;gap:10px;margin:14px 0 6px">
        <h3 style="margin:0">Dettaglio risposte (docente)</h3>
        <button id="exportPdfBtn" class="btn-secondary">Esporta PDF</button>
      </div>
      <div class="list" id="teacherList"></div>
    </div>

    <div id="teacherCta" style="display:none;margin-top:12px">
      <button id="openPinBtn" class="btn-secondary btn-block">Area docente (PIN)</button>
    </div>
  </div>

  <!-- Modale PIN -->
  <div id="pinModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="pinTitle">
    <div class="dialog">
      <h3 id="pinTitle">Inserisci PIN docente</h3>
      <div class="row">
        <input id="pinInput" type="password" inputmode="numeric" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <button id="pinLoginBtn">Accedi</button>
      </div>
      <div class="help">Il PIN protegge: voto per domanda, risposta corretta, esportazione PDF.</div>
      <div id="pinErr" style="color:#a10000;font-weight:700;margin-top:6px;display:none">PIN errato</div>
    </div>
  </div>

  <!-- Modale RIPRISTINO -->
  <div id="restoreModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="restoreTitle">
    <div class="dialog">
      <h3 id="restoreTitle">Ripristino verifica</h3>
      <p>üîÑ √à stato trovato un tentativo in corso. Vuoi riprendere la verifica da dove avevi interrotto?</p>
      <div class="actions">
        <button id="restoreContinue">Continua</button>
        <button id="restoreDiscard" class="btn-secondary">Annulla e riparti</button>
      </div>
    </div>
  </div>

  <div class="page-signature">by LG</div>

  <script>
    const PIN_SALT='nK$-13';
    const PIN_HASH='827703960df0ea495388fe2489d96f090701230416c9312be26d8b3a5e5d06fe'; // hash(salt+5822)
    let pinFailCount=0, pinLockedUntil=0, teacherUnlocked=false;

    /* ======= DOMANDE / PATTERN ======= */
    const questions = [
      { question: "Scrivi la formula e la reazione di sintesi dell'ossido ferrico:", answer: "2Fe‚Å∫¬≥+3O‚Åª¬≤‚ÜíFe‚ÇÇO‚ÇÉ" },
      { question: "Come si chiama NaOH in nomenclatura tradizionale?", answer: "IDROSSIDO DI SODIO" },
      { question: "Scrivi la formula e la reazione di sintesi dell'anidride perclorica:", answer: "2Cl‚Å∫‚Å∑+7O‚Åª¬≤‚ÜíCl‚ÇÇO‚Çá" },
      { question: "Come si chiama l'HCl in nomenclatura tradizionale?", answer: "ACIDO CLORIDRICO" },
      { question: "Scrivi la formula e la reazione di sintesi del triidruro di azoto:", answer: "N‚Åª¬≥+3H‚Å∫¬π‚ÜíNH‚ÇÉ" },
      { question: "Come si chiama H‚ÇÇSO‚ÇÑ in nomenclatura tradizionale?", answer: "ACIDO SOLFORICO" },
      { question: "Scrivi la formula e la reazione di sintesi dell'idrossido stannico:", answer: "Sn‚Å∫‚Å¥+2O‚Åª¬≤‚ÜíSn‚ÇÇO‚ÇÑ‚ÜíSnO‚ÇÇ+2H‚ÇÇO‚ÜíSn(OH)‚ÇÑ" },
      { question: "Come si chiama V(OH)‚ÇÖ?", answer: "IDROSSIDO DI VANADIO(V)" },
      { question: "Scrivi la formula e la reazione di sintesi dell'acido bromico:", answer: "2Br‚Å∫‚Åµ+5O‚Åª¬≤‚ÜíBr‚ÇÇO‚ÇÖ+H‚ÇÇO‚ÜíH‚ÇÇBr‚ÇÇO‚ÇÜ‚Üí2HBrO‚ÇÉ" },
      { question: "Come si chiama I‚ÇÇO‚ÇÖ in nomenclatura tradizionale?", answer: "ANIDRIDE IODICA" }
    ];
    const synthesisPatterns = {
      0: ['coef','slot','+','coef','slot','‚Üí','slot'],
      2: ['coef','slot','+','coef','slot','‚Üí','slot'],
      4: ['slot','+','coef','slot','‚Üí','slot'],
      6: ['slot','+','coef','slot','‚Üí','slot','‚Üí','slot','+','coef','slot','‚Üí','slot'],
      8: ['coef','slot','+','coef','slot','‚Üí','slot','+','slot','‚Üí','slot','‚Üí','coef','slot']
    };

    /* ======= UTIL ======= */
    const pad2 = n => String(n).padStart(2,'0');
    const formatDateIT = d => `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
    const formatTime = d => `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    const msToHMS = ms => { const s=Math.floor(ms/1000); return `${pad2(Math.floor(s/3600))}:${pad2(Math.floor((s%3600)/60))}:${pad2(s%60)}`; };
    let startTime=null,endTime=null,elapsedTimer=null;

    /* ======= CARET & BUILDER ======= */
    function caretOffsetWithin(el){
      try{
        const sel = window.getSelection();
        if(!sel || sel.rangeCount===0) return null;
        const r = sel.getRangeAt(0);
        if(!el.contains(r.startContainer)) return null;
        const pre = document.createRange();
        pre.selectNodeContents(el);
        pre.setEnd(r.startContainer, r.startOffset);
        return pre.toString().length;
      }catch{ return null }
    }
    function setSavedCaret(slot, idx){ slot.dataset.caret = String(Math.max(0, idx|0)); }
    function getSavedCaret(slot){ const n = Number(slot.dataset.caret); return Number.isFinite(n) ? Math.max(0,n) : (slot.textContent||'').length; }

    const getSlotsInBuilder = b => Array.from(b.querySelectorAll('.slot'));
    const getActiveSlot = b => b.querySelector('.slot.active')||getSlotsInBuilder(b)[0]||null;

    function setActiveSlot(s,preserveCaret){
      const b=s.closest('.builder-wrap');
      getSlotsInBuilder(b).forEach(x=>x.classList.remove('active'));
      s.classList.add('active');
      if(!preserveCaret){
        const off = caretOffsetWithin(s);
        setSavedCaret(s, off ?? (s.textContent||'').length);
      }
    }

    function insertAtSavedCaret(sym, wrap){
      const s=getActiveSlot(wrap)||getSlotsInBuilder(wrap)[0]; if(!s) return;
      const text = s.textContent || '';
      const i = getSavedCaret(s);
      s.textContent = text.slice(0,i) + sym + text.slice(i);
      setSavedCaret(s, i + sym.length);
      s.classList.remove('empty');
      autosave();
    }
    function softBackspace(wrap){
      const s=getActiveSlot(wrap); if(!s) return;
      const t=s.textContent||'';
      let i=getSavedCaret(s);
      if(i<=0){ if(t.length===0){s.classList.add('empty');setSavedCaret(s,0);return} i=1 }
      s.textContent = t.slice(0,i-1) + t.slice(i);
      setSavedCaret(s, Math.max(0,i-1));
      if((s.textContent||'').trim()==='') s.classList.add('empty');
      autosave();
    }
    function moveActive(b,dir){
      const slots=getSlotsInBuilder(b); if(!slots.length)return;
      const c=getActiveSlot(b)||slots[0]; const i=slots.indexOf(c);
      const n=slots[Math.min(Math.max(i+dir,0),slots.length-1)];
      if(n){ getSlotsInBuilder(b).forEach(x=>x.classList.remove('active')); n.classList.add('active');
        if(n.dataset.caret===undefined) setSavedCaret(n,(n.textContent||'').length);
      }
    }
    function clearActiveSlot(b){const s=getActiveSlot(b);if(!s)return;s.textContent='';s.classList.add('empty');setSavedCaret(s,0);autosave()}
    function clearAllSlots(b){getSlotsInBuilder(b).forEach(s=>{s.textContent='';s.classList.add('empty');setSavedCaret(s,0)});autosave()}

    function readBuilderValue(b){const parts=[];b.querySelectorAll('.formula > span').forEach(el=>{if(el.classList.contains('pair')){el.querySelectorAll('.slot').forEach(s=>parts.push(s.textContent))}else{parts.push(el.textContent)}});return parts.join('')}
    function readBuilderSlots(b){ return getSlotsInBuilder(b).map(s=>s.textContent||''); }
    function fillBuilderSlots(b, arr){ const slots=getSlotsInBuilder(b); slots.forEach((s,i)=>{ s.textContent = (arr && arr[i]) ? arr[i] : ''; if(s.textContent.trim()) s.classList.remove('empty'); else s.classList.add('empty'); setSavedCaret(s, (s.textContent||'').length); }); }

    function createSlot({coef=false}) {
      const slot = document.createElement('span');
      slot.className = 'slot empty' + (coef ? ' coef' : '');
      slot.contentEditable = 'true';
      slot.spellcheck = false;
      const upd = ()=>{ const off = caretOffsetWithin(slot); if(off!==null) setSavedCaret(slot, off); autosave(); };
      slot.addEventListener('focus', () => { setActiveSlot(slot, true); upd(); });
      slot.addEventListener('click', () => { setActiveSlot(slot, true); upd(); });
      slot.addEventListener('keyup', upd);
      slot.addEventListener('mouseup', upd);
      slot.addEventListener('input', () => {
        if (slot.textContent.trim().length > 0) slot.classList.remove('empty');
        else slot.classList.add('empty');
        const off = caretOffsetWithin(slot);
        setSavedCaret(slot, off ?? (slot.textContent||'').length);
        autosave();
      });
      return slot;
    }

    function createTwoLevelConsole(wrap){
      const dock = document.createElement('div');
      dock.className = 'kbd-dock';

      const sec1 = document.createElement('section');
      sec1.className = 'kbd-section';
      const t1 = document.createElement('div');
      t1.className = 'kbd-title';
      t1.textContent = 'Elementi & coefficienti';
      sec1.appendChild(t1);
      const rows1 = document.createElement('div');
      rows1.className = 'kbd-rows';

      const row1a = document.createElement('div'); row1a.className='kbd-row';
      ['Fe','Sn','H','N','O','Cl','S','Br','I','(',')','OH','H‚ÇÇO','Svuota slot'].forEach(label=>{
        const b=document.createElement('button'); b.type='button'; b.className='kbd-btn'+(label.length>2?' tool':''); b.textContent=label;
        if(label==='Svuota slot') b.addEventListener('click',()=>clearActiveSlot(wrap));
        else b.addEventListener('click',()=>insertAtSavedCaret(label,wrap));
        row1a.appendChild(b);
      });
      rows1.appendChild(row1a);

      const row1b = document.createElement('div'); row1b.className='kbd-row';
      ['1','2','3','4','5','6','7','8','‚óÄÔ∏é','‚ñ∂Ô∏é','‚å´','Svuota tutto'].forEach((label)=>{
        const b=document.createElement('button'); b.type='button'; b.className='kbd-btn'+(label.length>2?' tool':'');
        b.textContent=label;
        if(label==='‚óÄÔ∏é') b.addEventListener('click',()=>moveActive(wrap,-1));
        else if(label==='‚ñ∂Ô∏é') b.addEventListener('click',()=>moveActive(wrap,+1));
        else if(label==='‚å´') b.addEventListener('click',()=>softBackspace(wrap));
        else if(label==='Svuota tutto') b.addEventListener('click',()=>clearAllSlots(wrap));
        else b.addEventListener('click',()=>insertAtSavedCaret(label,wrap));
        row1b.appendChild(b);
      });
      rows1.appendChild(row1b);
      sec1.appendChild(rows1);
      dock.appendChild(sec1);

      const sec2 = document.createElement('section');
      sec2.className = 'kbd-section';
      const t2 = document.createElement('div');
      t2.className = 'kbd-title';
      t2.textContent = 'Numeri di ossidazione (sopra) & indici (sotto)';
      sec2.appendChild(t2);
      const rows2 = document.createElement('div');
      rows2.className = 'kbd-rows';

      const row2a = document.createElement('div'); row2a.className='kbd-row';
      ['‚Å∫¬π','‚Å∫¬≤','‚Å∫¬≥','‚Å∫‚Å¥','‚Å∫‚Åµ','‚Å∫‚Å∂','‚Å∫‚Å∑','‚Åª¬π','‚Åª¬≤','‚Åª¬≥','‚Åª‚Å¥'].forEach(sym=>{
        const b=document.createElement('button'); b.type='button'; b.className='kbd-btn no'; b.textContent=sym; b.addEventListener('click',()=>insertAtSavedCaret(sym,wrap)); row2a.appendChild(b);
      });
      rows2.appendChild(row2a);

      const row2b = document.createElement('div'); row2b.className='kbd-row';
      ['‚ÇÅ','‚ÇÇ','‚ÇÉ','‚ÇÑ','‚ÇÖ','‚ÇÜ','‚Çá','‚Çà'].forEach(sym=>{
        const b=document.createElement('button'); b.type='button'; b.className='kbd-btn sub'; b.textContent=sym; b.addEventListener('click',()=>insertAtSavedCaret(sym,wrap)); row2b.appendChild(b);
      });
      rows2.appendChild(row2b);

      sec2.appendChild(rows2);
      dock.appendChild(sec2);

      return dock;
    }

    function createBuilderFromPattern(pattern, qIndex) {
      const wrap = document.createElement('div');
      wrap.className = 'builder-wrap';
      wrap.dataset.qindex = qIndex;
      const formula = document.createElement('div');
      formula.className = 'formula';
      wrap.appendChild(formula);

      for (let i = 0; i < pattern.length; i++) {
        const tok = pattern[i];
        if (tok === 'coef' && pattern[i+1] === 'slot') {
          const pair = document.createElement('span');
          pair.className = 'pair';
          const coefSlot = createSlot({ coef:true });
          const normSlot = createSlot({ coef:false });
          setSavedCaret(coefSlot, 0);
          setSavedCaret(normSlot, 0);
          pair.appendChild(coefSlot);
          pair.appendChild(normSlot);
          formula.appendChild(pair);
          i++;
          continue;
        }
        if (tok === 'slot') {
          const s = createSlot({ coef:false });
          setSavedCaret(s, 0);
          formula.appendChild(s);
        }
        else if (tok === 'coef') {
          const s = createSlot({ coef:true });
          setSavedCaret(s, 0);
          formula.appendChild(s);
        }
        else {
          const st = document.createElement('span');
          st.className = 'static' + (tok === '‚Üí' ? ' arrow' : '');
          st.textContent = tok;
          formula.appendChild(st);
        }
      }

      const dock = createTwoLevelConsole(wrap);
      wrap.appendChild(dock);

      /* Pannello mobile con mini-tabelle */
      const mt = document.createElement('div');
      mt.className = 'mini-toggle';
      mt.innerHTML = '<button type="button" class="mini-btn" aria-expanded="false">Mostra mini-tabelle üìò</button>';
      const panel = document.createElement('div');
      panel.className = 'mini-panel';
      panel.setAttribute('hidden','');
      panel.innerHTML = `
        <table class="mini-table" aria-label="Ossidi/Idrossidi vs Nome" style="margin-bottom:8px">
          <thead><tr><th>Ossidi/Idrossidi</th><th>Nome</th></tr></thead>
          <tbody>
            <tr><td>N.O.</td><td>nome del Me</td></tr>
            <tr><td>2 N.O.</td><td>n.o. + basso ‚Üí suffisso oso; n.o. + alto ‚Üí suffisso ico</td></tr>
            <tr><td>‚â• 3 N.O.</td><td>n.o. + basso ‚Üí suffisso oso; n.o. successivo a quello + basso ‚Üí suffisso ico; n.o. superiori ‚Üí notazione di Stock</td></tr>
          </tbody>
        </table>
        <table class="mini-table" aria-label="Anidridi/Ossiacidi vs Nome">
          <thead><tr><th>Anidridi/Ossiacidi</th><th>Nome</th></tr></thead>
          <tbody>
            <tr><td>2 N.O.</td><td>n.o. + basso ‚Üí suffisso osa; n.o. + alto ‚Üí suffisso ica</td></tr>
            <tr><td>3 N.O.</td><td>+1 ‚Üí ipo___osa; +3 o +4 ‚Üí suffisso osa; +5 o +6 ‚Üí suffisso ica</td></tr>
            <tr><td>4 N.O.</td><td>+1 ‚Üí ipo___osa; +3 o +4 ‚Üí suffisso osa; +5 o +6 ‚Üí suffisso ica; +7 ‚Üí per___ica</td></tr>
          </tbody>
        </table>
        <table class="mini-table" aria-label="Idruri e Idracidi" style="margin-top:8px">
          <thead><tr><th>Categoria</th><th>Nome</th></tr></thead>
          <tbody>
            <tr><td>Idruri</td><td>Nomenclatura IUPAC</td></tr>
            <tr><td>Idracidi</td><td>___idrico</td></tr>
          </tbody>
        </table>
      `;
      mt.querySelector('button').addEventListener('click',(ev)=>{
        const btn = ev.currentTarget;
        const open = panel.classList.toggle('open');
        if(open){ panel.removeAttribute('hidden'); btn.setAttribute('aria-expanded','true'); btn.textContent='Nascondi mini-tabelle üìò'; }
        else { panel.setAttribute('hidden',''); btn.setAttribute('aria-expanded','false'); btn.textContent='Mostra mini-tabelle üìò'; }
      });
      wrap.appendChild(mt);
      wrap.appendChild(panel);

      return wrap;
    }

    /* ======= VALUTAZIONE ======= */
    function levenshtein(a,b){const m=[];for(let i=0;i<=b.length;i++)m[i]=[i];for(let j=0;j<=a.length;j++)m[0][j]=j;for(let i=1;i<=b.length;i++){for(let j=1;j<=a.length;j++){m[i][j]=b.charAt(i-1)===a.charAt(j-1)?m[i-1][j-1]:Math.min(m[i-1][j-1]+1,m[i][j-1]+1,m[i-1][j]+1)}}return m[b.length][a.length]}
    const RX_STRIP_EMPTY = /[\s+\u2192]/g;
    const normForEmpty = str => (str || '').replace(RX_STRIP_EMPTY, '').trim();
    const normForSim = (str, isSynth=false) => { let s=(str||'').replace(/\s+/g,''); if(!isSynth) s=s.toUpperCase(); return s; };
    const isEmptyAnswer = ans => normForEmpty(ans) === '';
    const getQuestionMax = i => synthesisPatterns[i] ? 2 : 1;

    function renderTeacherDetails(results){
      const tDiv = document.getElementById('teacherList');
      let html = '<ul>';
      results.forEach(e=>{
        const dispPoint = (Math.round(e.point*100)/100).toFixed(2);
        html+=`<li>
          <strong>Domanda:</strong> ${e.question}<br>
          <strong>Tua risposta:</strong> ${e.yourAnswer || '<em>(vuota)</em>'}<br>
          <strong>Risposta corretta:</strong> ${e.correctAnswer}<br>
          <strong>Punteggio domanda:</strong> ${dispPoint} / ${e.max}
        </li>`;
      });
      html += '</ul>';
      tDiv.innerHTML = html;
    }

    /* ======= PDF DOCENTE ======= */
    function exportPdf(){
      if(!teacherUnlocked){ alert('Area docente bloccata. Inserire il PIN.'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      function addSignature(){ doc.setFontSize(8); const text = 'by LG'; const w = doc.getTextWidth(text); doc.text(text, pageW - w - 5, pageH - 5) }
      function textWidthAt(str, size){ const old = doc.getFontSize(); if(size) doc.setFontSize(size); const w = doc.getTextWidth(str); if(size) doc.setFontSize(old); return w }
      function drawArrowInline(x,y,size=10){ const shaft=size*0.75, head=size*0.30; doc.setLineWidth(0.5); doc.line(x, y-1, x+shaft, y-1); const hx=x+shaft, hy=y-1; doc.line(hx,hy,hx+head,hy); doc.line(hx+head,hy,hx+head-2.4,hy-1.9); doc.line(hx+head,hy,hx+head-2.4,hy+1.9); return head + shaft }
      function drawGreaterEqualInline(x,y,size=10){ const w=size*0.52; doc.setLineWidth(0.5); doc.line(x, y-1.2, x+w, y-1.2); doc.line(x+w, y-1.2, x+w-3, y-1.2-2); doc.line(x+w, y-1.2, x+w-3, y-1.2+2); doc.line(x, y+1.2, x+w, y+1.2); return w + 1.2 }
      const SUP_MAP = { '‚Å∞':'0','¬π':'1','¬≤':'2','¬≥':'3','‚Å¥':'4','‚Åµ':'5','‚Å∂':'6','‚Å∑':'7','‚Å∏':'8','‚Åπ':'9','‚Å∫':'+','‚Åª':'-' };
      const SUB_MAP = { '‚ÇÄ':'0','‚ÇÅ':'1','‚ÇÇ':'2','‚ÇÉ':'3','‚ÇÑ':'4','‚ÇÖ':'5','‚ÇÜ':'6','‚Çá':'7','‚Çà':'8' };
      function chemToTokens(text){
        const tokens=[]; let i=0; text=String(text||'');
        while(i<text.length){
          const ch=text[i];
          if(ch==='‚Üí'){ tokens.push({type:'arrow'}); i++; continue }
          if(ch==='‚â•'){ tokens.push({type:'ge'}); i++; continue }
          if (SUP_MAP[ch]){ let s=''; while(i<text.length && SUP_MAP[text[i]]) s+=SUP_MAP[text[i++]]; tokens.push({type:'sup',val:s}); continue }
          if (SUB_MAP[ch]){ let s=''; while(i<text.length && SUB_MAP[text[i]]) s+=SUB_MAP[text[i++]]; tokens.push({type:'sub',val:s}); continue }
          let run='';
          while(i<text.length && !SUP_MAP[text[i]] && !SUB_MAP[text[i]] && text[i]!=='‚Üí' && text[i]!=='‚â•'){ run+=text[i++]; }
          if (run){ const parts = run.split(/(\s+)/); parts.forEach(p=>{ if(p) tokens.push({type:'base', val:p}) }); }
        }
        return tokens;
      }
      function measureTokenWidth(tok, baseSize=10){
        if(tok.type==='arrow') return drawArrowInline(0,0,baseSize);
        if(tok.type==='ge')    return drawGreaterEqualInline(0,0,baseSize);
        if(tok.type==='base')  return textWidthAt(tok.val, baseSize);
        const small = baseSize*0.75;
        if(tok.type==='sup' || tok.type==='sub') return textWidthAt(tok.val, small);
        return 0;
      }
      function wrapTokensToLines(tokens, maxWidth, baseSize=10){
        const lines=[]; let line=[], w=0;
        tokens.forEach(tok=>{
          const twTok = measureTokenWidth(tok, baseSize);
          if (w + twTok <= maxWidth || line.length===0){ line.push(tok); w += twTok; }
          else { lines.push(line); line=[tok]; w = twTok; }
        });
        if (line.length) lines.push(line);
        return lines;
      }
      function renderChemWrapped(text, x, y, maxWidth, baseSize=10, lineGap=9){
        const tokens = chemToTokens(String(text));
        const lines = wrapTokensToLines(tokens, maxWidth, baseSize);
        let cy = y;
        const oldSize = doc.getFontSize();
        lines.forEach(line=>{
          let cx = x;
          line.forEach(tok=>{
            if(tok.type==='arrow'){ cx += drawArrowInline(cx, cy, baseSize); }
            else if(tok.type==='ge'){ cx += drawGreaterEqualInline(cx, cy, baseSize); }
            else if(tok.type==='base'){ doc.setFontSize(baseSize); doc.text(tok.val, cx, cy); cx += textWidthAt(tok.val, baseSize); }
            else if(tok.type==='sup'){ const s=baseSize*0.75; doc.setFontSize(s); doc.text(tok.val, cx, cy - baseSize*0.35); cx += textWidthAt(tok.val, s); }
            else if(tok.type==='sub'){ const s=baseSize*0.75; doc.setFontSize(s); doc.text(tok.val, cx, cy + baseSize*0.25); cx += textWidthAt(tok.val, s); }
          });
          cy += lineGap;
          if (cy > pageH - 20){ doc.addPage(); addSignature(); cy = 12; }
        });
        doc.setFontSize(oldSize);
        return cy;
      }

      /* intestazione risultati */
      doc.setFontSize(14); doc.text('Verifica di Nomenclatura dei composti inorganici - Prima parte', 10, 10);
      doc.setFontSize(12);
      const dateStr=document.getElementById('date').value;
      const nameFull=document.getElementById('hdrStudent').textContent || '';
      const startStr=document.getElementById('hdrStart').textContent.replace('Inizio: ','') || '';
      const endStr=(function(){const d=new Date();return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`})();
      const elapsedStr=(function(){const r=document.getElementById('result').textContent.match(/Trascorso:\s*([0-9:]+)/);return r? r[1] : ''})()
      doc.text(`Studente: ${nameFull}`, 10, 20);
      doc.text(`Data: ${dateStr}`, 10, 28);
      doc.text(`Inizio: ${startStr}`, 10, 36);
      doc.text(`Fine: ${endStr}`, 10, 44);
      doc.text(`Trascorso: ${elapsedStr}`, 10, 52);

      const finalMatch = document.getElementById('result').textContent.match(/Punteggio:\s*([0-9.]+)\/10/);
      const finalScore = finalMatch ? finalMatch[1] : '';
      doc.text(`Punteggio finale: ${finalScore}/10`, 10, 60);

      let y=74; const baseSize=10, lineGap=9, blockGap=12; const rightMarginX = pageW - 10;
      const lis = Array.from(document.querySelectorAll('#teacherList li'));
      lis.forEach(li=>{
        const html=li.innerHTML;
        const getField=label=>{const rx=new RegExp(`<strong>${label}:<\/strong>\\s*([^<]+)`,'i'); const m=html.match(rx); return m?m[1]:''};
        const e={question:getField('Domanda'), yourAnswer:getField('Tua risposta')||'(vuota)', correctAnswer:getField('Risposta corretta'), point:getField('Punteggio domanda')};
        doc.setFontSize(baseSize); doc.text('Domanda:', 10, y); y = renderChemWrapped(e.question, 38, y, rightMarginX - 38, baseSize, lineGap);
        doc.text('Tua risposta:', 10, y); y = renderChemWrapped(e.yourAnswer, 38, y, rightMarginX - 38, baseSize, lineGap);
        doc.text('Risposta corretta:', 10, y); y = renderChemWrapped(e.correctAnswer, 58, y, rightMarginX - 58, baseSize, lineGap);
        doc.text(e.point ? `Punteggio: ${e.point}` : `Punteggio: ‚Äî`, 10, y); y += blockGap; if (y > pageH - 20) { doc.addPage(); addSignature(); y = 12; }
      });

      /* Mini-tabelle finali (Ossidi, Anidridi, Idruri/Idracidi) */
      doc.addPage(); addSignature();
      y = 14;

      function drawTable(titleLeft, titleRight, rows){
        const x = 10, w = pageW - 20, padX = 2;
        const col1W = 40;
        const col2W = w - col1W;

        const headerFont = 11;
        const cellFont   = 9;
        const supFont    = 6.8;
        const headerH    = 8.2;
        const lineH      = 4.4;
        const cellPadY   = 1.6;

        doc.setFontSize(headerFont);
        doc.setFillColor(230, 247, 230);
        doc.setDrawColor(166, 219, 166);
        doc.rect(x, y, col1W, headerH, 'F'); doc.rect(x+col1W, y, col2W, headerH, 'F');
        doc.rect(x, y, col1W, headerH); doc.rect(x+col1W, y, col2W, headerH);
        doc.setTextColor(0,95,0);
        doc.text(titleLeft, x+padX, y+headerH-2.2);
        doc.text(titleRight, x+col1W+padX, y+headerH-2.2);
        y += headerH; if (y > pageH - 25) { doc.addPage(); addSignature(); y = 12; }

        function renderTokenLines(arrLines, startX) {
          let yy = y + cellPadY + (lineH - 1.0);
          arrLines.forEach(line=>{
            let cx = startX;
            line.forEach(tok=>{
              if (tok.type==='ge')      { cx += drawGreaterEqualInline(cx, yy, cellFont); }
              else if (tok.type==='arrow'){ cx += drawArrowInline(cx, yy, cellFont); }
              else if (tok.type==='base'){ doc.setFontSize(cellFont); doc.text(tok.val, cx, yy); cx += textWidthAt(tok.val, cellFont); }
              else if (tok.type==='sup'){ doc.setFontSize(supFont);  doc.text(tok.val,cx,yy-(cellFont*0.35)); cx+=textWidthAt(tok.val,supFont); }
              else if (tok.type==='sub'){ doc.setFontSize(supFont);  doc.text(tok.val,cx,yy+(cellFont*0.25)); cx+=textWidthAt(tok.val,supFont); }
            });
            yy += lineH;
          });
        }

        doc.setTextColor(0,0,0);
        doc.setFontSize(cellFont);
        rows.forEach(r=>{
          const c1 = String(r[0]); const c2 = String(r[1]);
          const t1 = chemToTokens(c1);
          const t2 = chemToTokens(c2);
          const lines1 = wrapTokensToLines(t1, col1W - padX*2, cellFont);
          const lines2 = wrapTokensToLines(t2, col2W - padX*2, cellFont);
          const numLines = Math.max(lines1.length, lines2.length);
          const cellH = (lineH * numLines) + cellPadY*2;

          doc.setDrawColor(166,219,166);
          doc.rect(x, y, col1W, cellH);
          doc.rect(x+col1W, y, col2W, cellH);

          renderTokenLines(lines1, x + padX);
          renderTokenLines(lines2, x + col1W + padX);

          y += cellH; if (y > pageH - 25) { doc.addPage(); addSignature(); y = 12; }
        });

        y += 3;
      }

      const tblOssidi = [
        ['N.O.', 'nome del Me'],
        ['2 N.O.', 'n.o. + basso ‚Üí suffisso oso; n.o. + alto ‚Üí suffisso ico'],
        ['‚â• 3 N.O.', 'n.o. + basso ‚Üí suffisso oso; n.o. successivo a quello + basso ‚Üí suffisso ico; n.o. superiori ‚Üí notazione di Stock']
      ];
      drawTable('Ossidi/Idrossidi','Nome', tblOssidi);

      const tblAnidridi = [
        ['2 N.O.', 'n.o. + basso ‚Üí suffisso osa; n.o. + alto ‚Üí suffisso ica'],
        ['3 N.O.', '+1 ‚Üí ipo___osa; +3 o +4 ‚Üí suffisso osa; +5 o +6 ‚Üí suffisso ica'],
        ['4 N.O.', '+1 ‚Üí ipo___osa; +3 o +4 ‚Üí suffisso osa; +5 o +6 ‚Üí suffisso ica; +7 ‚Üí per___ica']
      ];
      drawTable('Anidridi/Ossiacidi','Nome', tblAnidridi);

      const tblIdruriIdracidi = [
        ['Idruri',   'Nomenclatura IUPAC'],
        ['Idracidi', '___idrico']
      ];
      drawTable('Categoria','Nome', tblIdruriIdracidi);

      addSignature();
      doc.save(`Verifica_${(nameFull.split(' (')[0] || 'Studente').replaceAll(' ','_')}.pdf`);

      /* >>> elimina salvataggio post-invio dopo export <<< */
      clearSubmittedState();
    }

    /* ======= PIN ======= */
    async function sha256Hex(str){
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    async function checkPin(input){
      if(!input) return false;
      try{ const hex = await sha256Hex(PIN_SALT + input); return hex === PIN_HASH; }catch{ return false }
    }
    function openPinModal(){
      document.getElementById('pinModal').classList.add('open');
      const input = document.getElementById('pinInput');
      input.value='';
      input.focus();
      document.getElementById('pinErr').style.display='none';
    }
    function closePinModal(){ document.getElementById('pinModal').classList.remove('open') }
    async function verifyPin(){
      const now = Date.now();
      if(now < pinLockedUntil){
        const sec = Math.ceil((pinLockedUntil-now)/1000);
        const err = document.getElementById('pinErr');
        err.textContent = `Attendi ${sec}s prima di riprovare.`;
        err.style.display='block';
        return;
      }
      const val = (document.getElementById('pinInput').value||'').trim();
      const ok = await checkPin(val);
      if(ok){
        teacherUnlocked = true;
        pinFailCount = 0; pinLockedUntil = 0;
        closePinModal();
        document.getElementById('teacherPanel').style.display='block';
        document.getElementById('teacherCta').style.display='none';
      } else {
        pinFailCount++;
        if(pinFailCount>=5){ pinLockedUntil = Date.now() + 60_000; pinFailCount=0; }
        const err = document.getElementById('pinErr');
        err.textContent = 'PIN errato';
        err.style.display='block';
      }
    }

    /* ======= STATO & AUTOSAVE ======= */
    const LS_KEY = 'verificaState_v1';

    function collectState(){
      const state = { phase:'started', student:{}, startTime:null, answers:{} };
      state.student.name = document.getElementById('name')?.value || '';
      state.student.surname = document.getElementById('surname')?.value || '';
      state.student.class = document.getElementById('class')?.value || '';
      state.student.date = document.getElementById('date')?.value || '';
      state.startTime = startTime ? startTime.toISOString() : null;

      questions.forEach((q,i)=>{
        if(synthesisPatterns[i]){
          const b = document.getElementById('builder_'+i);
          if(b){ state.answers[i] = { type:'synth', slots: readBuilderSlots(b) }; }
        }else{
          const v = (document.getElementById('q'+i)?.value)||'';
          state.answers[i] = { type:'text', value: v };
        }
      });
      return state;
    }
    function saveState(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(collectState())); }catch{} }
    const autosave = throttle(saveState, 300);
    function throttle(fn, wait){
      let t=0, pending=false;
      return function(){ const now=Date.now();
        if(!t || now-t>=wait){ t=now; fn(); }
        else if(!pending){ pending=true; setTimeout(()=>{ pending=false; t=Date.now(); fn(); }, t+wait-now); }
      }
    }
    function clearState(){ try{ localStorage.removeItem(LS_KEY); }catch{} }
    function hasSavedState(){
      try{ const s=localStorage.getItem(LS_KEY); if(!s) return null; return JSON.parse(s); }catch{ return null }
    }

    /* === Stato post-invio (persistente fino a export PDF) === */
    const LS_KEY_SUB = 'verificaSubmitted_v1';
    function saveSubmittedState(payload){
      try{ localStorage.setItem(LS_KEY_SUB, JSON.stringify(payload)); }catch{}
    }
    function getSubmittedState(){
      try{ const s = localStorage.getItem(LS_KEY_SUB); return s ? JSON.parse(s) : null; }catch{ return null }
    }
    function clearSubmittedState(){
      try{ localStorage.removeItem(LS_KEY_SUB); }catch{}
    }

    function restoreFromState(state){
      document.getElementById('preData').style.display='none';
      document.getElementById('examHeader').style.display='flex';

      const n = state.student.name || '', s = state.student.surname || '', c = state.student.class || '', dateStr = state.student.date || formatDateIT(new Date());
      document.getElementById('name').value = n;
      document.getElementById('surname').value = s;
      document.getElementById('class').value = c;
      document.getElementById('date').value = dateStr;

      document.getElementById('hdrStudent').textContent=`${n} ${s} (${c})`;
      document.getElementById('hdrDate').textContent=`Data: ${dateStr}`;

      startTime = state.startTime ? new Date(state.startTime) : new Date();
      document.getElementById('hdrStart').textContent=`Inizio: ${formatTime(startTime)}`;
      document.getElementById('hdrElapsed').textContent=`Trascorso: 00:00:00`;
      if(elapsedTimer) clearInterval(elapsedTimer);
      elapsedTimer=setInterval(()=>{const now=new Date();const diff=now-startTime;document.getElementById('hdrElapsed').textContent=`Trascorso: ${msToHMS(diff)}`;},1000);

      document.getElementById('quizRow').style.display = 'flex';
      document.getElementById('quizSide').style.display = (window.matchMedia('(min-width:1025px)').matches ? 'block' : 'none');

      document.getElementById('ox-row1').textContent = "nome del Me";
      document.getElementById('ox-row2').textContent = "n.o. + basso ‚Üí suffisso oso; n.o. + alto ‚Üí suffisso ico";
      document.getElementById('ox-row3').textContent = "n.o. + basso ‚Üí suffisso oso; n.o. successivo a quello + basso ‚Üí suffisso ico; n.o. superiori ‚Üí notazione di Stock";
      document.getElementById('an-row2').textContent = "n.o. + basso ‚Üí suffisso osa; n.o. + alto ‚Üí suffisso ica";
      document.getElementById('an-row3').textContent = "+1 ‚Üí ipo___osa; +3 o +4 ‚Üí suffisso osa; +5 o +6 ‚Üí suffisso ica";
      document.getElementById('an-row4').textContent = "+1 ‚Üí ipo___osa; +3 o +4 ‚Üí suffisso osa; +5 o +6 ‚Üí suffisso ica; +7 ‚Üí per___ica";

      document.getElementById('questions').style.display='block';
      const container=document.getElementById('questionsContainer'); container.innerHTML='';
      questions.forEach((q,i)=>{
        const block=document.createElement('div'); block.className='question-block';
        const label=document.createElement('div'); label.className='q-title'; label.innerHTML=(i+1)+". "+q.question; block.appendChild(label);

        if(synthesisPatterns[i]){
          const builder=createBuilderFromPattern(synthesisPatterns[i],i); builder.id='builder_'+i; block.appendChild(builder);
          const saved = state.answers?.[i];
          if(saved && saved.type==='synth'){ fillBuilderSlots(builder, saved.slots); }
        }else{
          const input=document.createElement('input'); input.type='text'; input.id='q'+i; input.placeholder='Risposta';
          input.className='answer-field'; input.maxLength=30;
          input.addEventListener('input',()=>{input.value=input.value.toUpperCase(); autosave();});
          const saved = state.answers?.[i];
          if(saved && saved.type==='text'){ input.value = saved.value || ''; }
          block.appendChild(input);
        }
        container.appendChild(block);
      });
    }

    /* === Ripristino stato post-invio === */
    function restoreSubmitted(state){
      document.getElementById('preData').style.display='none';
      document.getElementById('examHeader').style.display='none';
      document.getElementById('quizRow').style.display='none';
      document.getElementById('questions').style.display='none';
      document.getElementById('quizSide').style.display='none';

      const h = state.studentHeader;
      const res = `${h.nameFull} ‚Äî Data: ${h.date} ‚Äî Inizio: ${h.start} ‚Äî Fine: ${h.end} ‚Äî Trascorso: ${h.elapsed}<br>`
                + `Punteggio: ${state.finalScore}/10`
                + (state.finalScore>=6 ? " ‚Äî Ben fatto, continua a studiare üòâ" : " ‚Äî Peccato, studia meglio per la prossima verifica üí™");
      if(state.finalScore<6) document.body.style.backgroundColor='#ffefef';
      document.getElementById('result').innerHTML = res;

      const studentDiv = document.getElementById('studentList');
      let sHtml = '<h3>Le tue risposte</h3><ul>';
      (state.studentList||[]).forEach(e=>{
        sHtml += `<li><strong>Domanda:</strong> ${e.question}<br><strong>Tua risposta:</strong> ${e.yourAnswer || '<em>(vuota)</em>'}</li>`;
      });
      sHtml += '</ul>';
      studentDiv.innerHTML = sHtml;

      document.getElementById('teacherCta').style.display='block';
      renderTeacherDetails(state.teacherList||[]);
      const exportBtn = document.getElementById('exportPdfBtn');
      if (exportBtn) {
        exportBtn.replaceWith(exportBtn.cloneNode(true));
      }
      document.getElementById('exportPdfBtn').addEventListener('click', exportPdf, { once:true });

      const modal = document.getElementById('restoreModal');
      if(modal){
                modal.classList.add('open');
                const title = modal.querySelector('#restoreTitle');
                if(title) title.textContent = 'Risultati ripristinati';
                const p = modal.querySelector('p');
                if(p) p.textContent = 'Hai una consegna gi√† inviata. Puoi restare sui risultati oppure tornare all‚Äôinizio.';
                const actions = modal.querySelector('.actions');
                if(actions){
                  actions.innerHTML = '';

                  const stayBtn = document.createElement('button');
                  stayBtn.textContent = 'Resta sui risultati';
                  stayBtn.addEventListener('click', ()=> modal.classList.remove('open'));

                  const backBtn = document.createElement('button');
                  backBtn.textContent = 'Torna all‚Äôinizio';
                  backBtn.className = 'btn-secondary';
                  backBtn.addEventListener('click', ()=>{
                    modal.classList.remove('open');
                    resetToStartFromSubmitted();
                  });

                 actions.appendChild(stayBtn);
                 actions.appendChild(backBtn);

        }
      }
    }

    /* ======= FLUSSO ======= */
    function startQuiz(){
      const n=document.getElementById('name').value.trim(),
            s=document.getElementById('surname').value.trim(),
            c=document.getElementById('class').value.trim(),
            dateStr=document.getElementById('date').value.trim();
      if(!n||!s||!c){alert("Compila tutti i campi (nome, cognome, classe) per iniziare.");return;}

      document.getElementById('teacherPanel').style.display='none';
      document.getElementById('teacherCta').style.display='none';
      teacherUnlocked=false; pinFailCount=0; pinLockedUntil=0;

      document.getElementById('preData').style.display='none';
      document.getElementById('examHeader').style.display='flex';
      document.getElementById('hdrStudent').textContent=`${n} ${s} (${c})`;
      document.getElementById('hdrDate').textContent=`Data: ${dateStr}`;
      startTime=new Date();
      document.getElementById('hdrStart').textContent=`Inizio: ${formatTime(startTime)}`;
      document.getElementById('hdrElapsed').textContent=`Trascorso: 00:00:00`;
      if(elapsedTimer)clearInterval(elapsedTimer);
      elapsedTimer=setInterval(()=>{const now=new Date();const diff=now-startTime;document.getElementById('hdrElapsed').textContent=`Trascorso: ${msToHMS(diff)}`;},1000);

      document.getElementById('quizRow').style.display = 'flex';
      document.getElementById('quizSide').style.display = (window.matchMedia('(min-width:1025px)').matches ? 'block' : 'none');

      document.getElementById('ox-row1').textContent = "nome del Me";
      document.getElementById('ox-row2').textContent = "n.o. + basso ‚Üí suffisso oso; n.o. + alto ‚Üí suffisso ico";
      document.getElementById('ox-row3').textContent = "n.o. + basso ‚Üí suffisso oso; n.o. successivo a quello + basso ‚Üí suffisso ico; n.o. superiori ‚Üí notazione di Stock";
      document.getElementById('an-row2').textContent = "n.o. + basso ‚Üí suffisso osa; n.o. + alto ‚Üí suffisso ica";
      document.getElementById('an-row3').textContent = "+1 ‚Üí ipo___osa; +3 o +4 ‚Üí suffisso osa; +5 o +6 ‚Üí suffisso ica";
      document.getElementById('an-row4').textContent = "+1 ‚Üí ipo___osa; +3 o +4 ‚Üí suffisso osa; +5 o +6 ‚Üí suffisso ica; +7 ‚Üí per___ica";

      document.getElementById('questions').style.display='block';
      const container=document.getElementById('questionsContainer'); container.innerHTML='';
      questions.forEach((q,i)=>{
        const block=document.createElement('div'); block.className='question-block';
        const label=document.createElement('div'); label.className='q-title'; label.innerHTML=(i+1)+". "+q.question; block.appendChild(label);
        if(synthesisPatterns[i]){const builder=createBuilderFromPattern(synthesisPatterns[i],i); builder.id='builder_'+i; block.appendChild(builder);}
        else {
          const input=document.createElement('input'); input.type='text'; input.id='q'+i; input.placeholder='Risposta';
          input.className='answer-field'; input.maxLength=30;
          input.addEventListener('input',()=>{input.value=input.value.toUpperCase(); autosave();});
          block.appendChild(input);
        }
        container.appendChild(block);
      });

      autosave();
      ['name','surname','class'].forEach(id=>{
        const el=document.getElementById(id);
        el?.addEventListener('input', autosave);
      });
    }

    function submitQuiz(){
      if(!confirm("Vuoi davvero consegnare la verifica? Dopo l‚Äôinvio non potrai pi√π modificarla.")) return;

      const nameFull=document.getElementById('hdrStudent').textContent;
      const rawNameMatch=/^(.*?) \(/.exec(nameFull);
      const studentName=rawNameMatch?rawNameMatch[1]:nameFull;
      const classMatch=/\((.*?)\)/.exec(nameFull);
      const studentClass=classMatch?classMatch[1]:'';

      endTime=new Date();
      if(elapsedTimer){clearInterval(elapsedTimer); elapsedTimer=null}

      let totalScore=0, totalPossible=0;
      const results=[];

      questions.forEach((q,i)=>{
        const isSynth=!!synthesisPatterns[i];
        const maxVal=getQuestionMax(i);
        totalPossible+=maxVal;

        let userAnswer='';
        if(isSynth){ const builder=document.getElementById('builder_'+i); userAnswer=readBuilderValue(builder); }
        else { userAnswer=(document.getElementById('q'+i)?.value||'').trim().toUpperCase(); }

        let point=0;
        if(!isEmptyAnswer(userAnswer)){
          const u = normForSim(userAnswer, isSynth);
          const c = normForSim(isSynth ? q.answer : q.answer.toUpperCase(), isSynth);
          if(u.length>0 && c.length>0){
            const sim = 1 - (levenshtein(u, c) / Math.max(u.length, c.length));
            if(sim >= 1){ point = maxVal; }
            else if(sim < 0.2){ point = 0; }
            else { const pen = Math.max(0, sim - 0.05); point = maxVal * Math.pow(pen, 2); point = Math.max(0, Math.min(point, maxVal)); }
          }
        }
        totalScore+=point;

        results.push({ question:q.question, yourAnswer:userAnswer, correctAnswer:q.answer, point:point, max:maxVal });
      });

      const finalScore = Math.round((totalScore / totalPossible) * 10 * 100) / 100;

      const dateStr=document.getElementById('hdrDate').textContent.replace('Data: ','');
      const startStr=document.getElementById('hdrStart').textContent.replace('Inizio: ','');
      const endStr=formatTime(endTime);
      const elapsedStr=msToHMS(endTime - startTime);

      let res=`${studentName} (${studentClass}) ‚Äî Data: ${dateStr} ‚Äî Inizio: ${startStr} ‚Äî Fine: ${endStr} ‚Äî Trascorso: ${elapsedStr}<br>`;
      res += `Punteggio: ${finalScore}/10`;
      res += finalScore>=6 ? " ‚Äî Ben fatto, continua a studiare üòâ" : " ‚Äî Peccato, studia meglio per la prossima verifica üí™";
      if(finalScore<6) document.body.style.backgroundColor='#ffefef';
      document.getElementById('result').innerHTML=res;

      document.getElementById('examHeader').style.display = 'none';
      document.getElementById('quizSide').style.display = 'none';
      document.getElementById('questions').style.display='none';

      const studentDiv = document.getElementById('studentList');
      let sHtml = '<h3>Le tue risposte</h3><ul>';
      results.forEach(e=>{
        sHtml+=`<li><strong>Domanda:</strong> ${e.question}<br><strong>Tua risposta:</strong> ${e.yourAnswer || '<em>(vuota)</em>'}</li>`;
      });
      sHtml+="</ul>";
      studentDiv.innerHTML = sHtml;

      document.getElementById('teacherCta').style.display='block';
      renderTeacherDetails(results);
      document.getElementById('exportPdfBtn').addEventListener('click', exportPdf, { once:true });

      /* >>> salva stato post-invio e pulisci stato in-corso <<< */
      clearState();
      saveSubmittedState({
        phase: 'submitted',
        studentHeader: {
          nameFull: document.getElementById('hdrStudent').textContent,
          date: dateStr,
          start: startStr,
          end: endStr,
          elapsed: elapsedStr
        },
        finalScore,
        studentList: results.map(e=>({question:e.question, yourAnswer:e.yourAnswer})),
        teacherList: results,
        timestamp: Date.now()
      });

      document.getElementById('result').scrollIntoView({behavior:'smooth'});
    }

    function goBack(){
      if(!confirm('Vuoi davvero tornare indietro? Le risposte inserite andranno perse.')) return;
      if(elapsedTimer){ clearInterval(elapsedTimer); elapsedTimer=null }
      teacherUnlocked=false; pinFailCount=0; pinLockedUntil=0;
      document.getElementById('questionsContainer')?.replaceChildren();
      document.getElementById('questions').style.display='none';
      document.getElementById('result').innerHTML='';
      document.getElementById('studentList').innerHTML='';
      document.getElementById('teacherList').innerHTML='';
      document.getElementById('teacherPanel').style.display='none';
      document.getElementById('teacherCta').style.display='none';
      document.body.style.backgroundColor='var(--bg)';
      document.getElementById('preData').style.display='flex';
      document.getElementById('examHeader').style.display='none';
      document.getElementById('quizRow').style.display='none';
      document.getElementById('quizSide').style.display='none';
      clearState();
      clearSubmittedState(); /* <<< cancella anche lo stato post-invio */
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function resetToStartFromSubmitted(){
              if(elapsedTimer){ clearInterval(elapsedTimer); elapsedTimer=null; }
              clearState();
              clearSubmittedState();
              teacherUnlocked=false; pinFailCount=0; pinLockedUntil=0;

              document.getElementById('questionsContainer')?.replaceChildren();
              document.getElementById('questions').style.display='none';
              document.getElementById('result').innerHTML='';
              document.getElementById('studentList').innerHTML='';
              document.getElementById('teacherList').innerHTML='';
              document.getElementById('teacherPanel').style.display='none';
              document.getElementById('teacherCta').style.display='none';
              document.body.style.backgroundColor='var(--bg)';

              document.getElementById('preData').style.display='flex';
              document.getElementById('examHeader').style.display='none';
              document.getElementById('quizRow').style.display='none';
              document.getElementById('quizSide').style.display='none';

              window.scrollTo({top:0, behavior:'smooth'});
         }

    /* ======= EVENTI GLOBALI ======= */
    document.addEventListener('selectionchange', ()=>{
      const active = document.querySelector('.slot.active');
      if(active){
        const off = caretOffsetWithin(active);
        if(off!==null) setSavedCaret(active, off);
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      const dateEl = document.getElementById('date');
      if (dateEl) dateEl.value = formatDateIT(new Date());

      document.getElementById('teacherPanel').style.display='none';
      document.getElementById('teacherCta').style.display='none';

      document.getElementById('startBtn').addEventListener('click', startQuiz);
      document.getElementById('submitBtn').addEventListener('click', submitQuiz);
      document.getElementById('backBtn').addEventListener('click', goBack);

      document.getElementById('openPinBtn').addEventListener('click', openPinModal);
      document.getElementById('pinLoginBtn').addEventListener('click', verifyPin);
      document.getElementById('pinInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); verifyPin(); } });

      /* priorit√†: stato post-invio (mostra risultati) */
      const submitted = getSubmittedState();
      if(submitted && submitted.phase === 'submitted'){
        restoreSubmitted(submitted);
        return;
      }

      /* altrimenti proponi ripristino stato "in corso" */
      const saved = hasSavedState();
      if(saved && saved.phase==='started'){
        document.getElementById('restoreModal').classList.add('open');
        document.getElementById('restoreContinue').onclick = ()=>{
          document.getElementById('restoreModal').classList.remove('open');
          restoreFromState(saved);
        };
        document.getElementById('restoreDiscard').onclick = ()=>{
          document.getElementById('restoreModal').classList.remove('open');
          clearState();
        };
      }
    });
  </script>
</body>
</html>
